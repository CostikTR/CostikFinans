<!DOCTYPE html>
<html lang="tr" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finans Takip Uygulaması</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- ApexCharts for Charts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-container {
            transition: transform 0.3s ease;
        }
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #d1d5db; /* gray-300 */
            border-radius: 20px;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* dark:gray-600 */
        }
        .paid-transaction {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .transaction-item .actions {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .transaction-item:hover .actions {
            opacity: 1;
        }
        /* Notes list active item style */
        .note-list-item.active {
            background-color: #eef2ff; /* indigo-50 */
        }
        .dark .note-list-item.active {
            background-color: #3730a3; /* dark:indigo-800 */
        }
        /* Quill Editor Styling */
        #note-editor-container .ql-toolbar {
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            border-color: #d1d5db; /* gray-300 */
        }
        #note-editor-container .ql-container {
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            border-color: #d1d5db; /* gray-300 */
            font-size: 1rem;
        }
        .dark #note-editor-container .ql-toolbar, .dark #note-editor-container .ql-container {
            border-color: #4b5563; /* dark:gray-600 */
        }
        .dark #note-editor-container .ql-editor {
            color: #d1d5db; /* dark:text-gray-300 */
        }
        .dark #note-editor-container .ql-snow .ql-stroke {
            stroke: #9ca3af;
        }
        .dark #note-editor-container .ql-snow .ql-picker-label {
            color: #9ca3af;
        }
        /* Snackbar and Notification Styling */
        .notification-bar {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(-100%);
            opacity: 0;
        }
        .notification-bar.show {
            transform: translateY(0);
            opacity: 1;
        }
        /* Yükleme animasyonu için stil */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        /* Geri Al Snackbar Stili */
        #undo-snackbar {
            transform: translate(-50%, 100px);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            z-index: 40;
        }
        #undo-snackbar.show {
            transform: translate(-50%, 0);
            opacity: 1;
        }
        /* Hızlı Eylem Butonu Stilleri */
        #add-transaction-icon.rotate-45 {
            transform: rotate(45deg);
        }
        #quick-action-menu {
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
        }
        /* Yeni Menü Stilleri */
        .sidebar-link {
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar-link.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            font-weight: 600;
        }
        .sidebar-link.active i {
            color: white;
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">

    <!-- Yükleme Ekranı -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="spinner"></div>
    </div>

    <!-- Bildirim Alanı -->
    <div id="notification-bar" class="notification-bar fixed top-0 left-0 right-0 p-4 text-center text-white z-[100]">
        <span id="notification-message"></span>
    </div>

    <!-- Ana Konteyner -->
    <div id="app">

        <!-- Giriş ve Kayıt Ekranı -->
        <div id="auth-screen" class="fade-in min-h-screen flex items-center justify-center p-4">
            <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-xl w-full max-w-md mx-auto">
                <h1 class="text-3xl font-bold text-center mb-2 text-indigo-600 dark:text-indigo-400">FinansPro</h1>
                <p class="text-center text-slate-500 dark:text-slate-400 mb-8">Hesabınıza giriş yapın veya yeni hesap oluşturun.</p>
                <div class="flex border-b border-slate-200 dark:border-slate-700 mb-6">
                    <button id="login-tab-button" class="flex-1 py-2 font-semibold text-indigo-600 dark:text-indigo-400 border-b-2 border-indigo-600 dark:border-indigo-400">Giriş Yap</button>
                    <button id="register-tab-button" class="flex-1 py-2 font-semibold text-slate-500">Kayıt Ol</button>
                </div>
                <div id="auth-error" class="text-red-500 text-sm text-center mb-4 h-5"></div>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Email</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full px-4 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Şifre</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full px-4 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">Giriş Yap</button>
                </form>
                <form id="register-form" class="hidden space-y-6">
                    <div>
                        <label for="register-email" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Email</label>
                        <input type="email" id="register-email" required class="mt-1 block w-full px-4 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Şifre</label>
                        <input type="password" id="register-password" required class="mt-1 block w-full px-4 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">Hesap Oluştur</button>
                </form>
            </div>
        </div>

        <!-- Ana Uygulama Ekranı -->
        <div id="main-app-screen" class="hidden md:flex">
            <!-- Sol Menü (Sidebar) -->
            <aside class="w-64 bg-white dark:bg-slate-800 p-4 flex flex-col h-screen fixed shadow-lg">
                <div class="text-2xl font-bold text-indigo-600 dark:text-indigo-400 mb-8 text-center">
                    <i class="fa-solid fa-chart-pie mr-2"></i>FinansPro
                </div>
                <nav class="flex-grow flex flex-col space-y-2">
                    <a href="#" class="sidebar-link active flex items-center p-3 rounded-lg" data-page="finans-paneli-page">
                        <i class="fa-solid fa-house w-6 text-center text-slate-500"></i>
                        <span class="ml-3">Finans Panelim</span>
                    </a>
                    <a href="#" class="sidebar-link flex items-center p-3 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700" data-page="odemeler-page">
                        <i class="fa-solid fa-credit-card w-6 text-center text-slate-500"></i>
                        <span class="ml-3">Ödemeler</span>
                    </a>
                    <a href="#" class="sidebar-link flex items-center p-3 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700" data-page="raporlar-page">
                        <i class="fa-solid fa-chart-simple w-6 text-center text-slate-500"></i>
                        <span class="ml-3">Raporlar</span>
                    </a>
                    <a href="#" class="sidebar-link flex items-center p-3 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700" data-page="hedefler-page">
                        <i class="fa-solid fa-bullseye w-6 text-center text-slate-500"></i>
                        <span class="ml-3">Hedefler</span>
                    </a>
                </nav>

                <div class="mt-auto p-2 text-center text-sm text-slate-500">
                    <p id="user-email-display" class="font-semibold truncate"></p>
                    <p class="text-xs">© 2024 FinansPro</p>
                </div>
            </aside>

            <!-- Ana İçerik Alanı -->
            <main class="flex-1 md:ml-64 p-4 md:p-8">
                <header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                    <h1 id="page-title" class="text-4xl font-bold text-indigo-600 dark:text-indigo-400">Finans Panelim</h1>
                    <div class="flex items-center gap-2 flex-wrap justify-center">
                        <div class="relative">
                            <input type="text" id="search-input" placeholder="İşlemlerde Ara..." class="pl-10 pr-4 py-2 w-40 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        </div>
                        
                        <div class="flex items-center gap-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 shadow-sm">
                            <i class="fa-solid fa-wallet text-sky-500 dark:text-sky-400"></i>
                            <span id="account-balance-card" class="text-sm font-semibold text-slate-700 dark:text-slate-200">0.00 ₺</span>
                            <button id="add-balance-btn" class="text-sky-500 hover:text-sky-600 dark:text-sky-400 dark:hover:text-sky-300" title="Bakiye Yükle">
                                <i class="fa-solid fa-plus-circle"></i>
                            </button>
                        </div>

                        <button id="theme-toggle-btn" class="bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-bold py-2 px-3 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-600 transition-transform transform hover:scale-105 text-sm shadow-sm border dark:border-slate-600">
                            <i class="fa-solid fa-moon"></i>
                        </button>
                        <button id="notepad-btn" class="bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-bold py-2 px-3 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-600 transition-transform transform hover:scale-105 text-sm shadow-sm border dark:border-slate-600">
                            <i class="fa-solid fa-note-sticky"></i>
                        </button>
                        <button id="settings-btn" class="bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-bold py-2 px-3 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-600 transition-transform transform hover:scale-105 text-sm shadow-sm border dark:border-slate-600">
                            <i class="fa-solid fa-cog"></i>
                        </button>
                        <button id="logout-button" class="bg-red-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-transform transform hover:scale-105">
                            <i class="fa-solid fa-right-from-bracket"></i>
                        </button>
                    </div>
                </header>
                
                <div id="page-content">
                    <!-- FİNANS PANELİ SAYFASI -->
                    <div id="finans-paneli-page" class="page fade-in">
                        <div class="flex justify-end items-center mb-6 gap-2">
                             <button id="close-period-btn" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 transition-transform transform hover:scale-105 text-sm">
                                 <i class="fa-solid fa-calendar-check mr-2"></i>Dönemi Kapat ve Aktar
                             </button>
                             <button id="history-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition-transform transform hover:scale-105 text-sm">
                                 <i class="fa-solid fa-history mr-2"></i>İşlem Geçmişi
                             </button>
                            <button id="import-csv-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 text-sm">
                                <i class="fa-solid fa-file-import mr-2"></i>İçe Aktar
                            </button>
                            <button id="export-csv-btn" class="bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 transition-transform transform hover:scale-105 text-sm">
                                <i class="fa-solid fa-file-csv mr-2"></i>Dışa Aktar
                            </button>
                            <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                        </div>
                        
                        <div id="dashboard-view">
                            <div id="reminder-banner" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg mb-8 shadow-lg" role="alert">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="font-bold">Yaklaşan Ödemeler ve Hatırlatmalar</p>
                                        <div id="reminder-list" class="text-sm mt-2 space-y-1"></div>
                                    </div>
                                    <button id="close-reminder-btn" class="text-yellow-800 hover:text-yellow-900 text-2xl">&times;</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                                <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="relative overflow-hidden bg-gradient-to-br from-green-400 to-green-600 p-6 rounded-2xl shadow-xl text-white transition-transform transform hover:-translate-y-1"><div class="absolute -right-4 -bottom-4 opacity-20"><i class="fa-solid fa-wallet text-8xl"></i></div><h2 class="text-lg font-semibold text-green-100 mb-2">Bu Dönemki Gelir</h2><p id="total-income" class="text-3xl font-bold">0.00 ₺</p></div>
                                    <div class="relative overflow-hidden bg-gradient-to-br from-red-400 to-red-600 p-6 rounded-2xl shadow-xl text-white transition-transform transform hover:-translate-y-1"><div class="absolute -right-4 -bottom-4 opacity-20"><i class="fa-solid fa-receipt text-8xl"></i></div><h2 class="text-lg font-semibold text-red-100 mb-2">Bu Dönemki Gider</h2><p id="total-expense" class="text-3xl font-bold">0.00 ₺</p></div>
                                    <div class="md:col-span-2 relative overflow-hidden bg-gradient-to-br from-indigo-500 to-indigo-700 p-6 rounded-2xl shadow-xl text-white transition-transform transform hover:-translate-y-1"><div class="absolute -right-4 -bottom-4 opacity-20"><i class="fa-solid fa-scale-balanced text-8xl"></i></div><h2 class="text-lg font-semibold text-indigo-100 mb-2">Net Değer (Tüm Zamanlar)</h2><p id="balance" class="text-4xl font-bold">0.00 ₺</p></div>
                                </div>
                                <div id="chart-card" class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-xl"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-slate-700 dark:text-slate-300">Dönemlik Gider Dağılımı</h2><button id="toggle-chart-btn" class="text-slate-400 hover:text-indigo-500" title="Grafiği Gizle/Göster"><i class="fa-solid fa-eye"></i></button></div><div id="chart-container" class="relative h-64"><canvas id="expenseChart"></canvas></div></div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg flex flex-col lg:col-span-1"><h2 class="flex items-center gap-3 text-2xl font-bold mb-4 text-slate-700 dark:text-slate-300"><i class="fa-solid fa-tags"></i>Kategorileri Yönet</h2><form id="category-form" class="flex items-center gap-2 mb-4"><input type="text" name="categoryName" placeholder="Yeni Gider Kategorisi" required class="block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-sm"><button type="submit" class="bg-indigo-500 text-white font-bold p-2 rounded-md hover:bg-indigo-600 text-sm flex-shrink-0"><i class="fa-solid fa-plus"></i></button></form><div id="custom-category-list" class="space-y-2 flex-grow overflow-y-auto custom-scrollbar pr-2"></div></div>
                                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg flex flex-col lg:col-span-2"><div class="flex justify-between items-center mb-4"><h2 class="flex items-center gap-3 text-2xl font-bold text-slate-700 dark:text-slate-300"><i class="fa-solid fa-bullseye"></i>Bütçe Yönetimi</h2><div class="flex items-center gap-3"><button id="ai-budget-suggestion-btn" class="text-sm bg-violet-500 text-white font-semibold py-1 px-3 rounded-md hover:bg-violet-600">✨ Akıllı Bütçe Önerileri</button><button id="add-budget-btn" class="text-sm bg-indigo-500 text-white font-semibold py-1 px-3 rounded-md hover:bg-indigo-600">+ Ekle</button><button id="toggle-budget-list-btn" class="text-slate-400 hover:text-indigo-500" title="Bütçeleri Gizle/Göster"><i class="fa-solid fa-chevron-up"></i></button></div></div><div id="budget-list" class="space-y-4 overflow-y-auto custom-scrollbar pr-2 flex-grow"></div></div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg flex flex-col"><h2 class="flex items-center gap-3 text-3xl font-bold mb-4 text-green-500"><i class="fa-solid fa-circle-plus"></i>Gelirler</h2><div id="income-list" class="space-y-3 flex-grow mb-4 pr-2 overflow-y-auto max-h-[450px] custom-scrollbar"></div></div>
                                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg flex flex-col"><h2 class="flex items-center gap-3 text-3xl font-bold mb-4 text-red-500"><i class="fa-solid fa-building-columns"></i>Sabit Giderler</h2><div id="fixed-expense-list" class="space-y-3 flex-grow mb-4 pr-2 overflow-y-auto max-h-[450px] custom-scrollbar"></div></div>
                                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg flex flex-col"><h2 class="flex items-center gap-3 text-3xl font-bold mb-4 text-orange-500"><i class="fa-solid fa-cart-shopping"></i>Düzensiz Giderler</h2><div id="irregular-expense-list" class="space-y-3 flex-grow mb-4 pr-2 overflow-y-auto max-h-[450px] custom-scrollbar"></div></div>
                            </div>
                        </div>
                        <div id="history-view" class="hidden">
                            <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-slate-800 dark:text-slate-200">İşlem Geçmişi ve Analiz</h2><button id="back-to-dashboard-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-transform transform hover:scale-105 text-sm"><i class="fa-solid fa-arrow-left mr-2"></i>Panele Dön</button></div>
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-lg mb-6"><div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end"><div><label for="history-start-date" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Başlangıç Tarihi</label><input type="date" id="history-start-date" class="mt-1 block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-sm"></div><div><label for="history-end-date" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Bitiş Tarihi</label><input type="date" id="history-end-date" class="mt-1 block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-sm"></div><div><label for="history-category-filter" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Kategori</label><select id="history-category-filter" class="mt-1 block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-sm"></select></div></div><div class="flex flex-wrap gap-2 mt-4"><button data-period="1" class="date-filter-btn flex-1 text-sm bg-slate-200 dark:bg-slate-700 font-semibold py-2 px-3 rounded-md hover:bg-indigo-600 hover:text-white transition-colors">Son 1 Ay</button><button data-period="3" class="date-filter-btn flex-1 text-sm bg-slate-200 dark:bg-slate-700 font-semibold py-2 px-3 rounded-md hover:bg-indigo-600 hover:text-white transition-colors">Son 3 Ay</button><button data-period="6" class="date-filter-btn flex-1 text-sm bg-slate-200 dark:bg-slate-700 font-semibold py-2 px-3 rounded-md hover:bg-indigo-600 hover:text-white transition-colors">Son 6 Ay</button><button id="clear-history-filter" class="flex-1 text-sm bg-slate-500 text-white font-bold py-2 px-3 rounded-md hover:bg-slate-600">Temizle</button></div></div>
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg mb-6"><h3 class="text-xl font-bold text-slate-700 dark:text-slate-300 mb-4">Aylık Gelir & Gider Karşılaştırması</h3><div id="history-chart-container"></div></div>
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-bold text-slate-700 dark:text-slate-300 mb-4">Filtrelenmiş İşlemler</h3><div id="payment-history-list" class="space-y-4"></div></div>
                        </div>
                    </div>

                    <!-- GÜNCELLENDİ: ÖDEMELER SAYFASI -->
                    <div id="odemeler-page" class="page hidden fade-in">
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg">
                                <h3 class="text-lg font-semibold text-slate-500 dark:text-slate-400 mb-2">Toplam Kredi Kartı Borcu</h3>
                                <p id="total-card-debt" class="text-3xl font-bold text-red-500">0.00 ₺</p>
                            </div>
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg">
                                <h3 class="text-lg font-semibold text-slate-500 dark:text-slate-400 mb-2">Toplam Diğer Borçlar</h3>
                                <p id="total-manual-debt" class="text-3xl font-bold text-orange-500">0.00 ₺</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-2xl font-bold text-slate-700 dark:text-slate-300">Kredi Kartlarım</h2>
                                    <button id="add-credit-card-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-transform transform hover:scale-105 text-sm">
                                        <i class="fa-solid fa-plus mr-2"></i>Yeni Kart Ekle
                                    </button>
                                </div>
                                <div id="credit-card-list" class="space-y-6">
                                </div>
                            </div>
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg">
                                <h2 class="text-2xl font-bold text-slate-700 dark:text-slate-300 mb-4">Diğer Borçlarım</h2>
                                <form id="manual-debt-form" class="flex items-center gap-2 mb-4">
                                    <input type="text" name="debtDescription" placeholder="Borç Açıklaması (örn: Ahmet'e)" required class="block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-sm">
                                    <input type="number" name="debtAmount" placeholder="Tutar" required class="block w-40 px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-sm">
                                    <button type="submit" class="bg-green-500 text-white font-bold p-2 rounded-md hover:bg-green-600 text-sm flex-shrink-0"><i class="fa-solid fa-plus"></i></button>
                                </form>
                                <div id="manual-debt-list" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar pr-2">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RAPORLAR SAYFASI (Placeholder) -->
                    <div id="raporlar-page" class="page hidden fade-in">
                        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg text-center">
                            <i class="fa-solid fa-chart-simple text-6xl text-indigo-400 mb-4"></i>
                            <h2 class="text-2xl font-bold mb-2">Raporlar</h2>
                            <p class="text-slate-500">Detaylı finansal raporlar ve analizler yakında bu sayfada olacak.</p>
                        </div>
                    </div>

                    <!-- HEDEFLER SAYFASI (Placeholder) -->
                    <div id="hedefler-page" class="page hidden fade-in">
                        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg text-center">
                            <i class="fa-solid fa-bullseye text-6xl text-indigo-400 mb-4"></i>
                            <h2 class="text-2xl font-bold mb-2">Hedefler</h2>
                            <p class="text-slate-500">Finansal hedefler belirleyip takibini yapabileceğiniz alan yakında burada olacak.</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Geliştirilmiş Sabit Ekle Butonu ve Hızlı Eylem Menüsü -->
    <div class="fixed bottom-8 right-8 z-40">
        <div id="quick-action-menu" class="flex flex-col items-center space-y-3 mb-3 transition-all duration-300 transform scale-0 opacity-0 origin-bottom">
            <button id="quick-add-expense" class="bg-red-500 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg hover:bg-red-600 transition-transform transform hover:scale-110" title="Gider Ekle"><i class="fa-solid fa-arrow-trend-down text-xl"></i></button>
            <button id="quick-add-income" class="bg-green-500 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg hover:bg-green-600 transition-transform transform hover:scale-110" title="Gelir Ekle"><i class="fa-solid fa-arrow-trend-up text-xl"></i></button>
        </div>
        <button id="add-transaction-btn" class="bg-indigo-600 text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg hover:bg-indigo-700 transition-transform transform hover:scale-110 hidden"><i id="add-transaction-icon" class="fa-solid fa-plus text-2xl transition-transform duration-300"></i></button>
    </div>

    <!-- Modallar -->
    <div id="transaction-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay"><div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-8 w-full max-w-md modal-container transform scale-95"><h3 id="transaction-modal-title" class="text-2xl font-bold mb-6">Yeni İşlem Ekle</h3><form id="transaction-form" class="space-y-4"><div id="transaction-type-selector" class="grid grid-cols-2 gap-2"><button type="button" data-type="income" class="transaction-type-btn bg-slate-200 dark:bg-slate-700 p-3 rounded-lg font-semibold">Gelir</button><button type="button" data-type="expense" class="transaction-type-btn bg-slate-200 dark:bg-slate-700 p-3 rounded-lg font-semibold">Gider</button></div><div id="expense-type-selector" class="hidden grid grid-cols-2 gap-2"><button type="button" data-type="fixed" class="expense-type-btn bg-slate-200 dark:bg-slate-700 p-3 rounded-lg font-semibold">Sabit Gider</button><button type="button" data-type="irregular" class="expense-type-btn bg-slate-200 dark:bg-slate-700 p-3 rounded-lg font-semibold">Düzensiz Gider</button></div><div class="form-fields hidden space-y-4"><div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Açıklama</label><input type="text" name="description" required class="mt-1 block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm"></div><div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Tutar</label><input type="number" name="amount" step="0.01" required class="mt-1 block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm"></div><div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Kategori</label><select name="category" required class="mt-1 block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm"></select></div><div id="form-due-date-container" class="hidden"><label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Tarih</label><input type="date" name="dueDate" class="mt-1 block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm"></div><div id="form-installment-container" class="hidden"><label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Taksit Sayısı</label><input type="number" name="installmentCount" min="2" max="48" class="mt-1 block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm"></div><div class="flex items-center justify-between"><div id="form-recurring-container" class="hidden flex items-center"><input type="checkbox" name="isRecurring" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"><label class="ml-2 block text-sm text-slate-900 dark:text-slate-300">Her Ay Tekrarla</label></div><div id="form-is-installment-container" class="hidden flex items-center"><input type="checkbox" name="isInstallment" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"><label class="ml-2 block text-sm text-slate-900 dark:text-slate-300">Taksitli İşlem?</label></div></div><div class="flex justify-end space-x-4 pt-4"><button type="button" id="cancel-transaction-btn" class="px-6 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold">İptal</button><button type="submit" id="save-transaction-btn" class="px-6 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 font-semibold">Kaydet</button></div></div></form></div></div>
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay"><div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-8 w-full max-w-md modal-container transform scale-95"><h3 id="delete-modal-title" class="text-2xl font-bold mb-4">İşlemi Sil</h3><p id="delete-modal-text" class="text-slate-600 dark:text-slate-400 mb-6">Bu işlemi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.</p><div class="flex justify-end space-x-4"><button id="cancel-delete-btn" class="px-6 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold">İptal</button><button id="confirm-delete-btn" class="px-6 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 font-semibold">Sil</button></div></div></div>
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay"><div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-8 w-full max-w-md modal-container transform scale-95"><h3 class="text-2xl font-bold mb-6">İşlemi Düzenle</h3><form id="edit-form" class="space-y-4"><input type="hidden" name="id"><input type="hidden" name="type"><div><label for="edit-description" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Açıklama</label><input type="text" name="description" required class="mt-1 block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm"></div><div><label for="edit-amount" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Tutar</label><input type="number" name="amount" step="0.01" required class="mt-1 block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm"></div><div><label for="edit-category" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Kategori</label><select name="category" required class="mt-1 block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm"></select></div><div id="edit-dueDate-container" class="hidden"><label for="edit-dueDate" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Son Ödeme Tarihi</label><input type="date" name="dueDate" class="mt-1 block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm"></div><div id="edit-recurring-container" class="hidden flex items-center"><input type="checkbox" name="isRecurring" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"><label for="edit-isRecurring" class="ml-2 block text-sm text-slate-900 dark:text-slate-300">Her Ay Tekrarla</label></div><div class="flex justify-end space-x-4 pt-4"><button type="button" id="cancel-edit-btn" class="px-6 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold">İptal</button><button type="submit" class="px-6 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 font-semibold">Kaydet</button></div></form></div></div>
    <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay"><div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-8 w-full max-w-3xl modal-container transform scale-95 flex flex-col"><div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-bold">İşlemleri İçe Aktar</h3><button id="ai-categorize-btn" class="text-sm bg-violet-500 text-white font-semibold py-1 px-3 rounded-md hover:bg-violet-600">✨ Tümünü AI ile Kategorize Et</button></div><p class="text-slate-600 dark:text-slate-400 mb-6 text-sm">Lütfen işlemleri kontrol edin ve kategorileri doğrulayın. Sadece gider işlemleri içe aktarılacaktır.</p><div class="flex-grow overflow-y-auto custom-scrollbar border-t border-b dark:border-slate-700 py-4"><table class="min-w-full"><thead class="bg-slate-50 dark:bg-slate-700"><tr><th class="px-4 py-2 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Tarih</th><th class="px-4 py-2 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Açıklama</th><th class="px-4 py-2 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Tutar</th><th class="px-4 py-2 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Kategori</th></tr></thead><tbody id="import-preview-list" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700"></tbody></table></div><div class="flex justify-end space-x-4 pt-6"><button type="button" id="cancel-import-btn" class="px-6 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold">İptal</button><button type="button" id="confirm-import-btn" class="px-6 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-semibold disabled:opacity-50">Onayla ve Aktar</button></div></div></div>
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay"><div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-8 w-full max-w-md modal-container transform scale-95"><h3 class="text-2xl font-bold mb-6">Ayarlar</h3><form id="settings-form" class="space-y-4"><div><label for="payment-day" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Ödeme Günü (Her Ayın Kaçında?)</label><input type="number" name="paymentDay" min="1" max="28" required class="mt-1 block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm"><p class="text-xs text-slate-500 mt-1">Özetleriniz ve raporlarınız bu güne göre sıfırlanacaktır. (1-28 arası)</p></div><div class="flex justify-end space-x-4 pt-4"><button type="button" id="cancel-settings-btn" class="px-6 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold">İptal</button><button type="submit" class="px-6 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 font-semibold">Kaydet</button></div></form></div></div>
    <div id="budget-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay"><div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-8 w-full max-w-md modal-container transform scale-95"><h3 id="budget-modal-title" class="text-2xl font-bold mb-6">Bütçe Belirle</h3><form id="budget-form" class="space-y-4"><input type="hidden" name="category"><div id="budget-category-select-container" class="hidden"><label for="budget-category-select" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Kategori</label><select id="budget-category-select" required class="mt-1 block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm"></select></div><div id="budget-category-label-container"><label id="budget-category-label" class="block text-lg font-medium text-slate-700 dark:text-slate-300 mb-2"></label></div><div><label for="budget-amount" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Tutar</label><input type="number" id="budget-amount" name="amount" step="0.01" required placeholder="Bütçe Tutarı Girin" class="mt-1 block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm"></div><div class="flex justify-end space-x-4 pt-4"><button type="button" id="cancel-budget-btn" class="px-6 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold">İptal</button><button type="submit" class="px-6 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 font-semibold">Kaydet</button></div></form></div></div>
    <div id="ai-budget-suggestion-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay"><div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-8 w-full max-w-lg modal-container transform scale-95"><h3 class="text-2xl font-bold mb-4 text-violet-600 dark:text-violet-400">✨ Akıllı Bütçe Önerileri</h3><div id="ai-budget-suggestion-content" class="text-slate-600 dark:text-slate-300 mb-6 max-h-96 overflow-y-auto custom-scrollbar pr-4"></div><div class="flex justify-end"><button id="close-ai-budget-suggestion-btn" class="px-6 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold">Kapat</button></div></div></div>
    <div id="notepad-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay"><div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-0 w-full max-w-4xl modal-container transform scale-95 flex flex-col h-[70vh]"><div class="flex justify-between items-center p-4 border-b border-slate-200 dark:border-slate-700 flex-shrink-0"><h3 class="text-2xl font-bold">Not Defteri</h3><button id="close-notepad-btn" class="text-slate-400 hover:text-red-500 text-2xl">&times;</button></div><div class="flex flex-grow overflow-hidden"><div class="w-1/3 border-r border-slate-200 dark:border-slate-700 flex flex-col"><div class="p-3"><button id="new-note-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors text-sm"><i class="fa-solid fa-plus mr-2"></i>Yeni Not</button></div><div id="notes-list" class="flex-grow overflow-y-auto custom-scrollbar p-2 space-y-1"></div></div><div class="w-2/3 flex flex-col p-4"><input type="hidden" id="active-note-id"><input type="text" id="note-title-input" placeholder="Not Başlığı..." class="w-full bg-transparent text-2xl font-bold mb-4 p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-md dark:text-white"><div id="note-editor-container" class="w-full flex-grow flex flex-col relative"><div id="note-editor" class="h-full"></div></div><p id="notepad-status" class="text-xs text-slate-500 mt-2 h-4 text-right"></p></div></div></div></div>
    <!-- Bakiye Yükleme Modalı -->
    <div id="add-balance-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-8 w-full max-w-sm modal-container transform scale-95">
            <h3 class="text-2xl font-bold mb-6">Bakiye Yükle</h3>
            <form id="add-balance-form" class="space-y-4">
                <div>
                    <label for="balance-amount" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Yüklenecek Tutar</label>
                    <input type="number" name="amount" step="0.01" required class="mt-1 block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm">
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="cancel-add-balance-btn" class="px-6 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold">İptal</button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-sky-600 text-white hover:bg-sky-700 font-semibold">Yükle</button>
                </div>
            </form>
        </div>
    </div>
    <!-- GÜNCELLENDİ: Kredi Kartı Ekleme/Düzenleme Modalı -->
    <div id="credit-card-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-8 w-full max-w-md modal-container transform scale-95">
            <h3 id="credit-card-modal-title" class="text-2xl font-bold mb-6">Yeni Kredi Kartı Ekle</h3>
            <form id="credit-card-form" class="space-y-4">
                <input type="hidden" name="cardId">
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Kart Adı</label>
                    <input type="text" name="cardName" required placeholder="Garanti Bonus, Akbank Axess vb." class="mt-1 block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Banka</label>
                    <select name="bankName" class="mt-1 block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm">
                        <option>Diğer</option>
                        <option>Garanti</option>
                        <option>Akbank</option>
                        <option>İş Bankası</option>
                        <option>Yapı Kredi</option>
                        <option>QNB Finansbank</option>
                        <option>Halkbank</option>
                        <option>Vakıfbank</option>
                        <option>Ziraat Bankası</option>
                        <option>Denizbank</option>
                        <option>ING</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Kart Teması</label>
                    <div class="mt-2 grid grid-cols-4 gap-2">
                        <label class="cursor-pointer"><input type="radio" name="cardTheme" value="slate" class="sr-only" checked><span class="block h-10 w-full rounded-lg bg-gradient-to-br from-slate-700 to-slate-900 border-2 border-transparent ring-2 ring-offset-2 ring-offset-white dark:ring-offset-slate-800 ring-indigo-500"></span></label>
                        <label class="cursor-pointer"><input type="radio" name="cardTheme" value="blue" class="sr-only"><span class="block h-10 w-full rounded-lg bg-gradient-to-br from-blue-500 to-blue-700 border-2 border-transparent"></span></label>
                        <label class="cursor-pointer"><input type="radio" name="cardTheme" value="green" class="sr-only"><span class="block h-10 w-full rounded-lg bg-gradient-to-br from-green-500 to-green-700 border-2 border-transparent"></span></label>
                        <label class="cursor-pointer"><input type="radio" name="cardTheme" value="purple" class="sr-only"><span class="block h-10 w-full rounded-lg bg-gradient-to-br from-purple-500 to-purple-700 border-2 border-transparent"></span></label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Limit</label>
                    <input type="number" name="limit" step="0.01" required placeholder="Kart Limiti" class="mt-1 block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Ekstre Kesim Günü</label>
                    <input type="number" name="statementDay" min="1" max="28" required placeholder="Her ayın kaçında?" class="mt-1 block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Son Ödeme Günü</label>
                    <input type="number" name="paymentDueDay" min="1" max="28" required placeholder="Her ayın kaçında?" class="mt-1 block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm">
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="cancel-credit-card-btn" class="px-6 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold">İptal</button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 font-semibold">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
    <!-- GÜNCELLENDİ: Kredi Kartı Detay Modalı -->
    <div id="card-details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-6 w-full max-w-3xl modal-container transform scale-95 flex flex-col h-[85vh]">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 id="card-details-title" class="text-2xl font-bold">Kart Detayları</h3>
                <button id="close-card-details-btn" class="text-slate-400 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <div class="flex-grow overflow-y-auto custom-scrollbar pr-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg">
                        <p class="text-sm text-slate-500 dark:text-slate-400">Güncel Dönem Borcu</p>
                        <p id="card-statement-debt" class="text-2xl font-bold text-red-500">0.00 ₺</p>
                    </div>
                    <div class="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg">
                        <p class="text-sm text-slate-500 dark:text-slate-400">Asgari Ödeme Tutarı</p>
                        <p id="card-minimum-payment" class="text-2xl font-bold text-orange-500">0.00 ₺</p>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 mb-4">
                    <button id="pay-statement-debt-btn" class="flex-1 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 text-sm disabled:opacity-50">Dönem Borcunu Öde</button>
                    <button id="pay-minimum-debt-btn" class="flex-1 bg-orange-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-orange-600 text-sm disabled:opacity-50">Asgari Tutarı Öde</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-lg font-semibold mb-2">Harcama Ekle</h4>
                        <form id="card-debt-form" class="space-y-3">
                            <input type="hidden" name="cardId">
                            <input type="text" name="debtDescription" placeholder="Harcama Açıklaması" required class="block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-sm">
                            <input type="number" name="debtAmount" placeholder="Tutar" required class="block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-sm">
                            <select name="debtCategory" required class="block w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-sm"></select>
                            <button type="submit" class="w-full bg-blue-500 text-white font-bold py-2 rounded-md hover:bg-blue-600 text-sm">Ekle</button>
                        </form>
                        <div class="mt-4">
                            <h4 class="text-lg font-semibold mb-2">Harcama Dağılımı</h4>
                            <div id="card-debt-chart-container" class="relative h-48">
                                <canvas id="cardDebtChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold mb-2">Dönem İçi Harcamalar</h4>
                        <div id="card-debt-list" class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar"></div>
                        <h4 class="text-lg font-semibold mb-2 mt-4 border-t dark:border-slate-600 pt-4">Ödeme Geçmişi</h4>
                        <div id="card-payment-history-list" class="space-y-2 text-sm max-h-40 overflow-y-auto custom-scrollbar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="undo-snackbar" class="fixed bottom-8 left-1/2 bg-slate-800 dark:bg-slate-200 text-white dark:text-slate-800 px-6 py-3 rounded-lg shadow-lg flex items-center gap-4"><span id="undo-message">İşlem ödendi olarak işaretlendi.</span><button id="undo-btn" class="font-bold text-indigo-400 dark:text-indigo-600 hover:underline">Geri Al</button></div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, deleteDoc, updateDoc, serverTimestamp, orderBy, writeBatch, getDoc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDx17NJkAZknMvRyDlNuFYaMdlMGFa-QmQ",
            authDomain: "finans-sitem.firebaseapp.com",
            databaseURL: "https://finans-sitem-default-rtdb.firebaseio.com",
            projectId: "finans-sitem",
            storageBucket: "finans-sitem.appspot.com",
            messagingSenderId: "117402758273",
            appId: "1:117402758273:web:93a296f43e393352057180",
            measurementId: "G-WLLK7B3WB5"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM ELEMENTLERİ ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const notificationBar = document.getElementById('notification-bar');
        const notificationMessage = document.getElementById('notification-message');
        const authScreen = document.getElementById('auth-screen');
        const mainAppScreen = document.getElementById('main-app-screen');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const logoutButton = document.getElementById('logout-button');
        const authError = document.getElementById('auth-error');
        const loginTabButton = document.getElementById('login-tab-button');
        const registerTabButton = document.getElementById('register-tab-button');
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const importModal = document.getElementById('import-modal');
        const importPreviewList = document.getElementById('import-preview-list');
        const cancelImportBtn = document.getElementById('cancel-import-btn');
        const confirmImportBtn = document.getElementById('confirm-import-btn');
        const settingsModal = document.getElementById('settings-modal');
        const settingsForm = document.getElementById('settings-form');
        const cancelSettingsBtn = document.getElementById('cancel-settings-btn');
        const budgetModal = document.getElementById('budget-modal');
        const budgetForm = document.getElementById('budget-form');
        const cancelBudgetBtn = document.getElementById('cancel-budget-btn');
        const notepadModal = document.getElementById('notepad-modal');
        const closeNotepadBtn = document.getElementById('close-notepad-btn');
        const newNoteBtn = document.getElementById('new-note-btn');
        const notesList = document.getElementById('notes-list');
        const activeNoteIdInput = document.getElementById('active-note-id');
        const noteTitleInput = document.getElementById('note-title-input');
        const notepadStatus = document.getElementById('notepad-status');
        const categoryForm = document.getElementById('category-form');
        const customCategoryList = document.getElementById('custom-category-list');
        const budgetList = document.getElementById('budget-list');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const toggleChartBtn = document.getElementById('toggle-chart-btn');
        const chartContainer = document.getElementById('chart-container');
        const chartCard = document.getElementById('chart-card');
        const reminderBanner = document.getElementById('reminder-banner');
        const reminderList = document.getElementById('reminder-list');
        const closeReminderBtn = document.getElementById('close-reminder-btn');
        const searchInput = document.getElementById('search-input');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const importCsvBtn = document.getElementById('import-csv-btn');
        const csvFileInput = document.getElementById('csv-file-input');
        const dashboardView = document.getElementById('dashboard-view');
        const historyView = document.getElementById('history-view');
        const historyBtn = document.getElementById('history-btn');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
        const paymentHistoryList = document.getElementById('payment-history-list');
        const settingsBtn = document.getElementById('settings-btn');
        const notepadBtn = document.getElementById('notepad-btn');
        const toggleBudgetListBtn = document.getElementById('toggle-budget-list-btn');
        const addBudgetBtn = document.getElementById('add-budget-btn');
        const undoSnackbar = document.getElementById('undo-snackbar');
        const undoBtn = document.getElementById('undo-btn');
        const incomeList = document.getElementById('income-list');
        const fixedExpenseList = document.getElementById('fixed-expense-list');
        const irregularExpenseList = document.getElementById('irregular-expense-list');
        const historyStartDate = document.getElementById('history-start-date');
        const historyEndDate = document.getElementById('history-end-date');
        const historyCategoryFilter = document.getElementById('history-category-filter');
        const clearHistoryFilterBtn = document.getElementById('clear-history-filter');
        const historyChartContainer = document.getElementById('history-chart-container');
        const addTransactionBtn = document.getElementById('add-transaction-btn');
        const transactionModal = document.getElementById('transaction-modal');
        const transactionForm = document.getElementById('transaction-form');
        const cancelTransactionBtn = document.getElementById('cancel-transaction-btn');
        const addTransactionIcon = document.getElementById('add-transaction-icon');
        const quickActionMenu = document.getElementById('quick-action-menu');
        const quickAddIncomeBtn = document.getElementById('quick-add-income');
        const quickAddExpenseBtn = document.getElementById('quick-add-expense');
        const pageTitle = document.getElementById('page-title');
        const aiCategorizeBtn = document.getElementById('ai-categorize-btn');
        const aiBudgetSuggestionBtn = document.getElementById('ai-budget-suggestion-btn');
        const aiBudgetSuggestionModal = document.getElementById('ai-budget-suggestion-modal');
        const aiBudgetSuggestionContent = document.getElementById('ai-budget-suggestion-content');
        const closeAiBudgetSuggestionBtn = document.getElementById('close-ai-budget-suggestion-btn');
        const addBalanceModal = document.getElementById('add-balance-modal');
        const addBalanceForm = document.getElementById('add-balance-form');
        const cancelAddBalanceBtn = document.getElementById('cancel-add-balance-btn');
        const accountBalanceCard = document.getElementById('account-balance-card');
        const closePeriodBtn = document.getElementById('close-period-btn');
        const addCreditCardBtn = document.getElementById('add-credit-card-btn');
        const creditCardModal = document.getElementById('credit-card-modal');
        const creditCardForm = document.getElementById('credit-card-form');
        const cancelCreditCardBtn = document.getElementById('cancel-credit-card-btn');
        const creditCardList = document.getElementById('credit-card-list');
        const cardDetailsModal = document.getElementById('card-details-modal');
        const closeCardDetailsBtn = document.getElementById('close-card-details-btn');
        const cardDebtForm = document.getElementById('card-debt-form');
        const cardDebtList = document.getElementById('card-debt-list');
        const manualDebtForm = document.getElementById('manual-debt-form');
        const manualDebtList = document.getElementById('manual-debt-list');
        const payStatementDebtBtn = document.getElementById('pay-statement-debt-btn');
        const payMinimumDebtBtn = document.getElementById('pay-minimum-debt-btn');
        const totalCardDebtEl = document.getElementById('total-card-debt');
        const totalManualDebtEl = document.getElementById('total-manual-debt');
        const cardPaymentHistoryList = document.getElementById('card-payment-history-list');
        const cardDebtChartContainer = document.getElementById('card-debt-chart-container');


        // --- UYGULAMA DURUMU (STATE) ---
        let currentUserId = null;
        let transactionsUnsubscribe = null;
        let categoriesUnsubscribe = null;
        let notesUnsubscribe = null;
        let budgetsUnsubscribe = null;
        let creditCardsUnsubscribe = null;
        let manualDebtsUnsubscribe = null;
        let cardDebtsUnsubscribe = null;
        let itemToDelete = { id: null, type: null, subId: null };
        let allTransactions = [];
        let customCategories = [];
        let allNotes = [];
        let allBudgets = {};
        let allCreditCards = [];
        let allManualDebts = [];
        let currentCardDebts = [];
        let expenseChart = null;
        let historyChart = null; 
        let cardDebtChart = null; // Yeni
        let parsedCsvData = [];
        let userSettings = { paymentDay: 1, accountBalance: 0 };
        let noteSaveTimeout;
        let quill = null;
        let undoTimeoutId = null;

        // --- SABİTLER ---
        const defaultIncomeCategories = ['Maaş', 'Ek Gelir', 'Diğer Gelir'];
        const defaultFixedExpenseCategories = ['Kira', 'Fatura', 'Kredi', 'Abonelik'];
        const defaultIrregularExpenseCategories = ['Market', 'Ulaşım', 'Eğlence', 'Sağlık', 'Diğer Gider'];

        // --- GEMINI API FONKSİYONU ---
        async function callGemini(prompt) {
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    console.error("API isteği başarısız oldu:", response.status, await response.text());
                    return null;
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("API yanıtında beklenen içerik bulunamadı:", result);
                    return null;
                }
            } catch (error) {
                console.error("Gemini API'ye bağlanırken hata oluştu:", error);
                return null;
            }
        }


        // --- SAYFA NAVİGASYONU ---
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.sidebar-link');

        function navigateTo(pageId) {
            pages.forEach(page => {
                page.classList.toggle('hidden', page.id !== pageId);
            });
            navLinks.forEach(link => {
                const linkPageId = link.dataset.page;
                link.classList.toggle('active', linkPageId === pageId);
                if (linkPageId === pageId) {
                    pageTitle.textContent = link.querySelector('span').textContent;
                }
            });
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = e.currentTarget.dataset.page;
                navigateTo(pageId);
            });
        });

        // --- YARDIMCI FONKSİYONLAR ---
        function showNotification(message, type = 'error') {
            notificationMessage.textContent = message;
            notificationBar.className = 'notification-bar show fixed top-0 left-0 right-0 p-4 text-center text-white z-[100]';
            if (type === 'success') notificationBar.classList.add('bg-green-500');
            else if (type === 'info') notificationBar.classList.add('bg-sky-500');
            else notificationBar.classList.add('bg-red-500');
            setTimeout(() => {
                notificationBar.classList.remove('show');
            }, 3000);
        }

        function toggleLoading(show) {
            loadingOverlay.classList.toggle('hidden', !show);
        }

        // --- TEMA YÖNETİMİ ---
        const applyTheme = (theme) => {
            const icon = themeToggleBtn.querySelector('i');
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                icon.classList.replace('fa-moon', 'fa-sun');
            } else {
                document.documentElement.classList.remove('dark');
                icon.classList.replace('fa-sun', 'fa-moon');
            }
            localStorage.setItem('theme', theme);
            if (expenseChart) updateExpenseChart(allTransactions);
            if (historyChart) renderHistoryChart(allTransactions);
        };
        const toggleTheme = () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
        };
        const initializeTheme = () => {
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);
        };
        themeToggleBtn.addEventListener('click', toggleTheme);
        initializeTheme();

        // --- KİMLİK DOĞRULAMA (AUTHENTICATION) ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('user-email-display').textContent = user.email;
                authScreen.classList.add('hidden');
                mainAppScreen.classList.remove('hidden');
                addTransactionBtn.classList.remove('hidden');
                
                toggleLoading(true);
                navigateTo('finans-paneli-page');
                initializeQuillEditor();
                await loadAllData();
                toggleLoading(false);

            } else {
                currentUserId = null;
                authScreen.classList.remove('hidden');
                mainAppScreen.classList.add('hidden');
                addTransactionBtn.classList.add('hidden');
                if (transactionsUnsubscribe) transactionsUnsubscribe();
                if (categoriesUnsubscribe) categoriesUnsubscribe();
                if (notesUnsubscribe) notesUnsubscribe();
                if (budgetsUnsubscribe) budgetsUnsubscribe();
                if (creditCardsUnsubscribe) creditCardsUnsubscribe();
                if (manualDebtsUnsubscribe) manualDebtsUnsubscribe();
                if (cardDebtsUnsubscribe) cardDebtsUnsubscribe();
                clearUI();
            }
        });

        // --- VERİ YÜKLEME ---
        async function loadAllData() {
            await Promise.all([
                loadSettings(),
                loadCategories(),
                loadBudgets(),
                loadNotes(),
                loadCreditCards(),
                loadManualDebts()
            ]);
            await loadTransactions();
            initializeBudgetToggle();
        }
        
        // --- AYARLAR (SETTINGS) ---
        async function loadSettings() {
            if (!currentUserId) return;
            const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/settings/main`);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                userSettings = {
                    paymentDay: data.paymentDay || 1,
                    accountBalance: data.accountBalance || 0
                };
            } else {
                userSettings = { paymentDay: 1, accountBalance: 0 };
            }
            updateBalanceDisplay();
        }
        
        settingsBtn.addEventListener('click', () => {
            settingsForm.paymentDay.value = userSettings.paymentDay;
            settingsModal.classList.remove('hidden');
        });
        cancelSettingsBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPaymentDay = parseInt(settingsForm.paymentDay.value);
            if (newPaymentDay >= 1 && newPaymentDay <= 28) {
                userSettings.paymentDay = newPaymentDay;
                const settingsToSave = { paymentDay: userSettings.paymentDay, accountBalance: userSettings.accountBalance };
                const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/settings/main`);
                try {
                    await setDoc(docRef, settingsToSave);
                    settingsModal.classList.add('hidden');
                    displayTransactions();
                    updateSummary(allTransactions);
                    updateExpenseChart(allTransactions);
                    displayBudgets();
                    showNotification('Ayarlar kaydedildi.', 'success');
                } catch (error) {
                    console.error("Ayarlar kaydedilemedi:", error);
                    showNotification('Ayarlar kaydedilemedi.');
                }
            } else {
                showNotification('Lütfen 1-28 arasında bir gün girin.');
            }
        });

        // --- BAKİYE YÖNETİMİ ---
        function updateBalanceDisplay() {
            const balanceElement = document.getElementById('account-balance-card');
            if (balanceElement) {
                 balanceElement.textContent = `${userSettings.accountBalance.toFixed(2)} ₺`;
            }
        }

        async function updateBalanceInFirestore(newBalance) {
            if (!currentUserId) return;
            userSettings.accountBalance = newBalance;
            const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/settings/main`);
            try {
                await setDoc(docRef, userSettings, { merge: true });
            } catch (error) {
                console.error("Bakiye güncellenemedi:", error);
                showNotification('Bakiye güncellenirken bir hata oluştu.');
            }
        }

        document.getElementById('add-balance-btn').addEventListener('click', () => {
            addBalanceForm.reset();
            addBalanceModal.classList.remove('hidden');
        });

        cancelAddBalanceBtn.addEventListener('click', () => {
            addBalanceModal.classList.add('hidden');
        });

        addBalanceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const amountToAdd = parseFloat(e.target.amount.value);
            if (isNaN(amountToAdd) || amountToAdd <= 0) {
                showNotification('Lütfen geçerli bir tutar girin.');
                return;
            }
            const newBalance = userSettings.accountBalance + amountToAdd;
            await updateBalanceInFirestore(newBalance);
            updateBalanceDisplay();
            addBalanceModal.classList.add('hidden');
            showNotification(`${amountToAdd.toFixed(2)} ₺ bakiye eklendi.`, 'success');
        });

        closePeriodBtn.addEventListener('click', async () => {
            const { startDate, endDate } = getPreviousFinancialCycle(userSettings.paymentDay);
            
            const previousCycleTransactions = allTransactions.filter(tx => {
                const txDate = tx.createdAt?.toDate();
                return txDate && txDate >= startDate && txDate <= endDate;
            });

            if (previousCycleTransactions.length === 0) {
                showNotification('Önceki döneme ait işlem bulunamadı.');
                return;
            }

            const cycleIncome = previousCycleTransactions
                .filter(tx => tx.type === 'income')
                .reduce((sum, tx) => sum + tx.amount, 0);

            const cycleExpense = previousCycleTransactions
                .filter(tx => tx.type === 'expense' && tx.isPaid)
                .reduce((sum, tx) => sum + tx.amount, 0);

            const netChange = cycleIncome - cycleExpense;
            const newBalance = userSettings.accountBalance + netChange;

            await updateBalanceInFirestore(newBalance);
            updateBalanceDisplay();

            const message = `Önceki dönemden kalan ${netChange.toFixed(2)} ₺ bakiyenize aktarıldı.`;
            showNotification(message, 'success');
        });


        // --- KATEGORİ YÖNETİMİ ---
        function loadCategories() {
            if (!currentUserId) return;
            if (categoriesUnsubscribe) categoriesUnsubscribe();
            const q = query(collection(db, `artifacts/${appId}/users/${currentUserId}/categories`), orderBy("name"));
            return new Promise((resolve) => {
                categoriesUnsubscribe = onSnapshot(q, (snapshot) => {
                    customCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateCategoryDropdowns();
                    displayCustomCategories();
                    displayBudgets();
                    populateHistoryCategoryFilter();
                    resolve();
                }, (error) => {
                    console.error("Kategoriler yüklenemedi:", error);
                    resolve();
                });
            });
        }
        function updateCategoryDropdowns() {
            populateSelect(transactionForm.querySelector('select[name="category"]'), []);
        }
        function populateSelect(selectElement, options) {
            selectElement.innerHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
        }
        function displayCustomCategories() {
            if (customCategories.length === 0) {
                customCategoryList.innerHTML = `<p class="text-slate-500 text-sm">Özel kategori yok.</p>`;
                return;
            }
            customCategoryList.innerHTML = customCategories.map(cat => `<div class="flex justify-between items-center text-sm p-2 rounded-md bg-slate-100 dark:bg-slate-700"><span class="font-medium">${cat.name}</span><button data-id="${cat.id}" class="delete-category-btn text-slate-400 hover:text-red-500 text-xs"><i class="fa-solid fa-trash-can"></i></button></div>`).join('');
            customCategoryList.querySelectorAll('.delete-category-btn').forEach(button => {
                button.addEventListener('click', (e) => deleteCategory(e.currentTarget.dataset.id));
            });
        }
        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const categoryName = categoryForm.categoryName.value.trim();
            if (!categoryName) return;
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/categories`), { name: categoryName });
                categoryForm.reset();
            } catch (error) { 
                console.error("Kategori eklenemedi:", error);
                showNotification('Kategori eklenemedi.');
            }
        });
        async function deleteCategory(id) {
            if (!currentUserId) return;
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/categories/${id}`));
            } catch (error) { 
                console.error("Kategori silinemedi:", error);
                showNotification('Kategori silinemedi.');
            }
        }

        // --- İŞLEM YÖNETİMİ (TRANSACTIONS) ---
        addTransactionBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            quickActionMenu.classList.toggle('scale-0');
            quickActionMenu.classList.toggle('opacity-0');
            addTransactionIcon.classList.toggle('rotate-45');
        });
        function closeQuickActionMenu() {
            quickActionMenu.classList.add('scale-0', 'opacity-0');
            addTransactionIcon.classList.remove('rotate-45');
        }
        document.addEventListener('click', (e) => {
            if (!addTransactionBtn.parentElement.contains(e.target)) {
                closeQuickActionMenu();
            }
        });
        quickAddIncomeBtn.addEventListener('click', () => {
            openTransactionModalWithType('income');
            closeQuickActionMenu();
        });
        quickAddExpenseBtn.addEventListener('click', () => {
            openTransactionModalWithType('expense');
            closeQuickActionMenu();
        });
        function openTransactionModalWithType(type) {
            transactionForm.reset();
            document.getElementById('transaction-type-selector').classList.add('hidden');
            document.getElementById('expense-type-selector').classList.add('hidden');
            document.querySelector('.form-fields').classList.add('hidden');
            document.querySelectorAll('.transaction-type-btn, .expense-type-btn').forEach(btn => btn.classList.remove('active'));
            transactionModal.classList.remove('hidden');
            if (type === 'income') {
                document.querySelector('.transaction-type-btn[data-type="income"]').classList.add('active');
                setupTransactionForm('income');
            } else if (type === 'expense') {
                document.querySelector('.transaction-type-btn[data-type="expense"]').classList.add('active');
                document.getElementById('expense-type-selector').classList.remove('hidden');
            }
        }
        function closeTransactionModal() {
            transactionModal.classList.add('hidden');
            transactionForm.reset();
            document.getElementById('transaction-type-selector').classList.remove('hidden');
            document.getElementById('expense-type-selector').classList.add('hidden');
            document.querySelector('.form-fields').classList.add('hidden');
            document.querySelectorAll('.transaction-type-btn, .expense-type-btn').forEach(btn => btn.classList.remove('active'));
        }
        cancelTransactionBtn.addEventListener('click', closeTransactionModal);
        document.querySelectorAll('.transaction-type-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                const type = e.currentTarget.dataset.type;
                document.querySelectorAll('.transaction-type-btn').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                if(type === 'income') {
                    document.getElementById('expense-type-selector').classList.add('hidden');
                    setupTransactionForm('income');
                } else {
                    document.getElementById('expense-type-selector').classList.remove('hidden');
                    document.querySelector('.form-fields').classList.add('hidden');
                }
            });
        });
        document.querySelectorAll('.expense-type-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                const type = e.currentTarget.dataset.type;
                document.querySelectorAll('.expense-type-btn').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                setupTransactionForm(type);
            });
        });
        function setupTransactionForm(type) {
            const formFields = document.querySelector('.form-fields');
            const categorySelect = transactionForm.querySelector('select[name="category"]');
            const dueDateContainer = document.getElementById('form-due-date-container');
            const installmentContainer = document.getElementById('form-installment-container');
            const isInstallmentContainer = document.getElementById('form-is-installment-container');
            const recurringContainer = document.getElementById('form-recurring-container');
            const dueDateInput = transactionForm.querySelector('input[name="dueDate"]');
            [dueDateContainer, installmentContainer, isInstallmentContainer, recurringContainer].forEach(el => el.classList.add('hidden'));
            dueDateInput.required = false;
            if (type === 'income') {
                populateSelect(categorySelect, defaultIncomeCategories);
                dueDateContainer.classList.remove('hidden');
                recurringContainer.classList.remove('hidden');
            } else if (type === 'fixed') {
                populateSelect(categorySelect, defaultFixedExpenseCategories);
                dueDateContainer.classList.remove('hidden');
                isInstallmentContainer.classList.remove('hidden');
                recurringContainer.classList.remove('hidden');
                dueDateInput.required = true;
            } else if (type === 'irregular') {
                const allIrregular = [...defaultIrregularExpenseCategories, ...customCategories.map(c => c.name)];
                populateSelect(categorySelect, allIrregular);
                dueDateContainer.classList.remove('hidden');
                isInstallmentContainer.classList.remove('hidden');
            }
            formFields.classList.remove('hidden');
        }
        transactionForm.querySelector('input[name="isInstallment"]').addEventListener('change', e => {
            document.getElementById('form-installment-container').classList.toggle('hidden', !e.target.checked);
            if(e.target.checked) {
                transactionForm.querySelector('input[name="isRecurring"]').checked = false;
            }
        });
        transactionForm.querySelector('input[name="isRecurring"]').addEventListener('change', e => {
            const dueDateInput = transactionForm.querySelector('input[name="dueDate"]');
            const isChecked = e.target.checked;
            dueDateInput.required = isChecked;
            if(isChecked) {
                transactionForm.querySelector('input[name="isInstallment"]').checked = false;
                document.getElementById('form-installment-container').classList.add('hidden');
            }
        });
        transactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = transactionForm.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            const formData = new FormData(transactionForm);
            const description = formData.get('description');
            const amount = parseFloat(formData.get('amount'));
            const category = formData.get('category');
            const type = defaultIncomeCategories.includes(category) ? 'income' : 'expense';
            const isRecurring = formData.get('isRecurring') === 'on';
            const isInstallment = formData.get('isInstallment') === 'on';
            const installmentCount = isInstallment ? parseInt(formData.get('installmentCount')) : 0;
            let dueDate = formData.get('dueDate');
            if (type === 'expense' && !isRecurring && !isInstallment && !dueDate) {
                dueDate = new Date().toISOString().split('T')[0];
            }
            if (!description.trim() || !category || isNaN(amount) || amount <= 0) {
                showNotification("Lütfen tüm alanları doğru bir şekilde doldurun.");
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
                return;
            }
            try {
                const collectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/transactions`);
                if (isInstallment) {
                    const batch = writeBatch(db);
                    const installmentAmount = amount / installmentCount;
                    const installmentGroupId = crypto.randomUUID();
                    const [startYear, startMonth, startDay] = dueDate.split('-').map(Number);
                    for (let i = 0; i < installmentCount; i++) {
                        const installmentDate = new Date(Date.UTC(startYear, startMonth - 1, startDay));
                        installmentDate.setUTCMonth(installmentDate.getUTCMonth() + i);
                        const newDocRef = doc(collectionRef);
                        batch.set(newDocRef, {
                            description: `${description} (${i + 1}/${installmentCount})`,
                            amount: installmentAmount, category, type,
                            dueDate: installmentDate.toISOString().split('T')[0],
                            isPaid: false, isInstallment: true, installmentGroupId,
                            createdAt: serverTimestamp()
                        });
                    }
                    await batch.commit();
                } else {
                    const data = { description, amount, category, type, createdAt: serverTimestamp() };
                    const activeExpenseTypeBtn = transactionForm.querySelector('.expense-type-btn.active');
                    const expenseSubtype = activeExpenseTypeBtn ? activeExpenseTypeBtn.dataset.type : null;

                    if (type === 'expense' && expenseSubtype === 'irregular') {
                        data.isPaid = true;
                        const newBalance = userSettings.accountBalance - amount;
                        await updateBalanceInFirestore(newBalance);
                        updateBalanceDisplay();
                    } else {
                        data.isPaid = false;
                    }
                    
                    if (dueDate) data.dueDate = dueDate;
                    if (isRecurring) data.isRecurring = true;
                    await addDoc(collectionRef, data);
                }
                closeTransactionModal();
                showNotification('İşlem eklendi.', 'success');
            } catch (error) {
                console.error("İşlem eklenirken hata oluştu: ", error);
                showNotification('İşlem eklenirken bir hata oluştu.');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        });
        function loadTransactions() {
            if (!currentUserId) return;
            if (transactionsUnsubscribe) transactionsUnsubscribe();
            const q = query(collection(db, `artifacts/${appId}/users/${currentUserId}/transactions`), orderBy("createdAt", "desc"));
            return new Promise((resolve) => {
                transactionsUnsubscribe = onSnapshot(q, (snapshot) => {
                    allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    checkAndCreateRecurringTransactions(allTransactions);
                    displayTransactions();
                    updateSummary(allTransactions);
                    updateExpenseChart(allTransactions);
                    checkReminders();
                    displayPaymentHistory();
                    displayBudgets();
                    resolve();
                }, (error) => {
                    console.error("İşlemler yüklenemedi:", error);
                    resolve();
                });
            });
        }
        function displayTransactions() {
            const searchTerm = searchInput.value.toLowerCase();
            const { startDate, endDate } = getCurrentFinancialCycle(userSettings.paymentDay);
            const filtered = allTransactions.filter(tx => tx.description.toLowerCase().includes(searchTerm) || tx.category.toLowerCase().includes(searchTerm));
            const incomes = filtered.filter(tx => { const txDate = tx.createdAt?.toDate(); return tx.type === 'income' && txDate >= startDate && txDate <= endDate; });
            
            const fixedExpenses = filtered.filter(tx => 
                tx.type === 'expense' && !tx.isPaid && (defaultFixedExpenseCategories.includes(tx.category) || tx.isInstallment)
            );
            fixedExpenses.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

            const irregularExpenses = filtered.filter(tx => { const txDate = tx.createdAt?.toDate(); return tx.type === 'expense' && !tx.isInstallment && !defaultFixedExpenseCategories.includes(tx.category) && txDate >= startDate && txDate <= endDate; });
            renderList(incomeList, incomes, 'Bu dönemde gelir yok.');
            renderList(fixedExpenseList, fixedExpenses, 'Ödenecek sabit gider/taksit yok.');
            renderList(irregularExpenseList, irregularExpenses, 'Bu dönemde düzensiz gider yok.');
        }
        function renderList(container, transactions, emptyMessage) {
            if (!container) return;
            if (transactions.length === 0) {
                container.innerHTML = `<p class="text-slate-500 text-sm">${emptyMessage}</p>`;
                return;
            }
            container.innerHTML = transactions.map(tx => {
                const isIncome = tx.type === 'income';
                const dueDateHTML = tx.dueDate ? `<p class="text-xs text-slate-500">Tarih: ${new Date(tx.dueDate + 'T00:00:00Z').toLocaleDateString('tr-TR')}</p>` : '';
                const paidCheckboxHTML = container.id === 'fixed-expense-list' ? `<input type="checkbox" data-id="${tx.id}" class="paid-checkbox h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500 mr-3" ${tx.isPaid ? 'checked' : ''}>` : '';
                const editButtonHTML = !tx.isInstallment ? `<button data-id="${tx.id}" data-type="transaction" class="edit-btn text-slate-400 hover:text-indigo-500 text-xs"><i class="fa-solid fa-pencil"></i></button>` : '';
                return `<div class="transaction-item flex justify-between items-center text-sm p-2 rounded-md transition-colors hover:bg-slate-100 dark:hover:bg-slate-700/50" data-id="${tx.id}"><div class="flex items-center flex-grow truncate">${paidCheckboxHTML}<div class="truncate ${tx.isPaid ? 'paid-transaction' : ''}"><p class="font-semibold truncate">${tx.description}</p><div class="flex items-center space-x-2"><p class="text-xs text-slate-500">${tx.category}</p>${dueDateHTML}</div></div></div><div class="text-right ml-2 flex-shrink-0"><p class="font-bold ${isIncome ? 'text-green-500' : 'text-red-500'} ${tx.isPaid ? 'paid-transaction' : ''}">${isIncome ? '+' : '-'} ${tx.amount.toFixed(2)}₺</p><div class="actions flex items-center justify-end space-x-2 mt-1">${editButtonHTML}<button data-id="${tx.id}" data-type="transaction" class="delete-btn text-slate-400 hover:text-red-500 text-xs"><i class="fa-solid fa-trash-can"></i></button></div></div></div>`;
            }).join('');
            container.querySelectorAll('.paid-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        const listItem = e.target.closest('.transaction-item');
                        e.target.disabled = true;
                        listItem.classList.add('paid-transaction');
                        showUndoSnackbar(e.target.dataset.id);
                    }
                });
            });
            container.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => openDeleteModal(e.currentTarget.dataset.id, 'transaction'));
            });
            container.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const transaction = allTransactions.find(t => t.id === e.currentTarget.dataset.id);
                    if(transaction) openEditModal(transaction);
                });
            });
        }
        function showUndoSnackbar(transactionId) {
            clearTimeout(undoTimeoutId);
            const paidTransaction = allTransactions.find(tx => tx.id === transactionId);
            if (!paidTransaction) return;
            undoSnackbar.classList.add('show');
            const undoHandler = () => {
                clearTimeout(undoTimeoutId);
                const listItem = document.querySelector(`.transaction-item[data-id="${transactionId}"]`);
                if (listItem) {
                    const checkbox = listItem.querySelector('.paid-checkbox');
                    checkbox.checked = false;
                    checkbox.disabled = false;
                    listItem.classList.remove('paid-transaction');
                }
                hideUndoSnackbar();
            };
            undoBtn.addEventListener('click', undoHandler, { once: true });
            undoTimeoutId = setTimeout(() => {
                handlePayment(paidTransaction);
                hideUndoSnackbar();
                undoBtn.removeEventListener('click', undoHandler);
            }, 5000);
        }
        function hideUndoSnackbar() {
            undoSnackbar.classList.remove('show');
        }
        async function handlePayment(transactionToPay) {
            const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/transactions/${transactionToPay.id}`);
            try {
                const newBalance = userSettings.accountBalance - transactionToPay.amount;
                await updateBalanceInFirestore(newBalance);
                updateBalanceDisplay();
                await updateDoc(docRef, { isPaid: true });
            } catch (error) {
                console.error("Ödendi durumu güncellenemedi:", error);
                showNotification('Ödeme durumu güncellenemedi.');
                const listItem = document.querySelector(`.transaction-item[data-id="${transactionToPay.id}"]`);
                if (listItem) {
                    const checkbox = listItem.querySelector('.paid-checkbox');
                    checkbox.checked = false;
                    checkbox.disabled = false;
                    listItem.classList.remove('paid-transaction');
                }
                const revertedBalance = userSettings.accountBalance + transactionToPay.amount;
                await updateBalanceInFirestore(revertedBalance);
                updateBalanceDisplay();
            }
        }
        async function checkAndCreateRecurringTransactions(transactions) {
            const recurringTemplates = transactions.filter(tx => tx.isRecurring && !tx.isPaid);
            if (recurringTemplates.length === 0) return;
            const batch = writeBatch(db);
            let hasNewTransactions = false;
            const today = new Date();
            today.setUTCHours(0, 0, 0, 0);
            for (const template of recurringTemplates) {
                if (!template.dueDate) continue;
                const [year, month, day] = template.dueDate.split('-').map(Number);
                let nextDueDate = new Date(Date.UTC(year, month - 1, day));
                const templateCreationDate = template.createdAt?.toDate() || new Date(0);
                while (nextDueDate <= templateCreationDate) {
                    nextDueDate.setUTCMonth(nextDueDate.getUTCMonth() + 1);
                }
                while (nextDueDate <= today) {
                    const nextDueDateString = nextDueDate.toISOString().split('T')[0];
                    const alreadyExists = transactions.some(tx => tx.description === template.description && tx.category === template.category && tx.dueDate === nextDueDateString);
                    if (!alreadyExists) {
                        const newTransactionData = { ...template };
                        delete newTransactionData.id;
                        delete newTransactionData.isRecurring;
                        newTransactionData.dueDate = nextDueDateString;
                        newTransactionData.createdAt = serverTimestamp();
                        newTransactionData.isPaid = false;
                        const newDocRef = doc(collection(db, `artifacts/${appId}/users/${currentUserId}/transactions`));
                        batch.set(newDocRef, newTransactionData);
                        hasNewTransactions = true;
                    }
                    nextDueDate.setUTCMonth(nextDueDate.getUTCMonth() + 1);
                }
            }
            if (hasNewTransactions) {
                try {
                    await batch.commit();
                } catch (error) {
                    console.error("Tekrarlanan işlemler oluşturulurken hata:", error);
                }
            }
        }
        
        function checkReminders() {
            const today = new Date();
            today.setUTCHours(0, 0, 0, 0);
            
            const expenseReminders = allTransactions
                .filter(tx => tx.type === 'expense' && tx.dueDate && !tx.isPaid)
                .map(tx => {
                    const dueDate = new Date(tx.dueDate + 'T00:00:00Z');
                    const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                    return { ...tx, diffDays };
                })
                .filter(tx => tx.diffDays <= 7)
                .sort((a, b) => a.diffDays - b.diffDays)
                .map(tx => {
                    if (tx.diffDays < 0) return `<div><i class="fa-solid fa-receipt text-red-500 mr-2"></i><strong>${tx.description}</strong> ödemesinin günü geçti!</div>`;
                    if (tx.diffDays === 0) return `<div><i class="fa-solid fa-receipt text-red-500 mr-2"></i><strong>${tx.description}</strong> ödemesinin bugün son günü!</div>`;
                    return `<div><i class="fa-solid fa-receipt text-yellow-600 mr-2"></i><strong>${tx.description}</strong> ödemesine ${tx.diffDays} gün kaldı.</div>`;
                });

            const cardReminders = allCreditCards.map(card => {
                const nextDueDate = new Date(today.getFullYear(), today.getMonth(), card.paymentDueDay);
                if (nextDueDate < today) {
                    nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                }
                const diffDays = Math.ceil((nextDueDate - today) / (1000 * 60 * 60 * 24));
                if (diffDays <= 7) {
                     if (diffDays === 0) return `<div><i class="fa-solid fa-credit-card text-red-500 mr-2"></i><strong>${card.cardName}</strong> son ödeme günü bugün!</div>`;
                    return `<div><i class="fa-solid fa-credit-card text-yellow-600 mr-2"></i><strong>${card.cardName}</strong> son ödeme gününe ${diffDays} gün kaldı.</div>`;
                }
                return null;
            }).filter(Boolean);


            const allReminders = [...expenseReminders, ...cardReminders];

            if (allReminders.length > 0) {
                reminderList.innerHTML = allReminders.join('');
                reminderBanner.classList.remove('hidden');
            } else {
                reminderBanner.classList.add('hidden');
            }
        }
        closeReminderBtn.addEventListener('click', () => reminderBanner.classList.add('hidden'));
        toggleChartBtn.addEventListener('click', () => {
            chartCard.classList.toggle('hidden');
        });
        function updateExpenseChart(transactions) {
            const { startDate, endDate } = getCurrentFinancialCycle(userSettings.paymentDay);
            const cycleTransactions = transactions.filter(tx => { const txDate = tx.createdAt?.toDate(); return txDate && txDate >= startDate && txDate <= endDate; });
            const expenses = cycleTransactions.filter(tx => tx.type === 'expense');
            const categoryTotals = expenses.reduce((acc, tx) => { acc[tx.category] = (acc[tx.category] || 0) + tx.amount; return acc; }, {});
            const labels = Object.keys(categoryTotals);
            const data = Object.values(categoryTotals);
            if (expenseChart) expenseChart.destroy();
            if (labels.length === 0) {
                 chartContainer.innerHTML = '<p class="text-center text-slate-500 mt-20">Bu dönem için gider verisi yok.</p>';
                 return;
            } else {
                 chartContainer.innerHTML = '<canvas id="expenseChart"></canvas>';
            }
            const canvas = document.getElementById('expenseChart');
            if (canvas) {
                 expenseChart = new Chart(canvas.getContext('2d'), {
                    type: 'doughnut',
                    data: { labels, datasets: [{ data, backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7'], borderColor: document.documentElement.classList.contains('dark') ? '#1e293b' : '#ffffff', borderWidth: 2 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: document.documentElement.classList.contains('dark') ? '#d1d5db' : '#4b5563', boxWidth: 12, padding: 15 } } } }
                });
            }
        }
        function getCurrentFinancialCycle(paymentDay) {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            const currentDay = today.getDate();
            let startYear, startMonth, endYear, endMonth;
            if (currentDay >= paymentDay) {
                startYear = currentYear;
                startMonth = currentMonth;
            } else {
                startYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                startMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            }
            endYear = startMonth === 11 ? startYear + 1 : startYear;
            endMonth = startMonth === 11 ? 0 : startMonth + 1;
            const startDate = new Date(startYear, startMonth, paymentDay);
            startDate.setHours(0,0,0,0);
            const endDate = new Date(endYear, endMonth, paymentDay - 1);
            endDate.setHours(23, 59, 59, 999);
            return { startDate, endDate };
        }
        function getPreviousFinancialCycle(paymentDay) {
            const { startDate: currentCycleStartDate } = getCurrentFinancialCycle(paymentDay);
            
            const endDate = new Date(currentCycleStartDate);
            endDate.setDate(endDate.getDate() - 1);
            endDate.setHours(23, 59, 59, 999);

            const startDate = new Date(currentCycleStartDate);
            startDate.setMonth(startDate.getMonth() - 1);
            startDate.setHours(0, 0, 0, 0);

            return { startDate, endDate };
        }
        function updateSummary(transactions) {
            const { startDate, endDate } = getCurrentFinancialCycle(userSettings.paymentDay);
            const cycleTransactions = transactions.filter(tx => { const txDate = tx.createdAt?.toDate(); return txDate && txDate >= startDate && txDate <= endDate; });
            const totalIncome = cycleTransactions.filter(tx => tx.type === 'income').reduce((sum, tx) => sum + tx.amount, 0);
            const totalExpense = cycleTransactions.filter(tx => tx.type === 'expense').reduce((sum, tx) => sum + tx.amount, 0);
            const overallBalance = transactions.reduce((bal, tx) => { if (tx.type === 'income') return bal + tx.amount; if (tx.type === 'expense' && tx.isPaid) return bal - tx.amount; return bal; }, 0);
            document.getElementById('total-income').textContent = `${totalIncome.toFixed(2)} ₺`;
            document.getElementById('total-expense').textContent = `${totalExpense.toFixed(2)} ₺`;
            document.getElementById('balance').textContent = `${overallBalance.toFixed(2)} ₺`;
        }
        function clearUI() {
            [customCategoryList, incomeList, fixedExpenseList, irregularExpenseList, budgetList, creditCardList, manualDebtList].forEach(list => { if (list) list.innerHTML = ''; });
            updateSummary([]);
            if (expenseChart) {
                expenseChart.destroy();
                chartContainer.innerHTML = '<canvas id="expenseChart"></canvas>';
            }
        }
        historyBtn.addEventListener('click', () => {
            dashboardView.classList.add('hidden');
            historyView.classList.remove('hidden');
            populateHistoryCategoryFilter(); 
            displayPaymentHistory(); 
        });
        backToDashboardBtn.addEventListener('click', () => {
            historyView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
        });
        function populateHistoryCategoryFilter() {
            const allExpenseCategories = [...defaultFixedExpenseCategories, ...defaultIrregularExpenseCategories, ...customCategories.map(c => c.name)];
            const uniqueCategories = [...new Set(allExpenseCategories)].sort(); 
            historyCategoryFilter.innerHTML = '<option value="">Tüm Kategoriler</option>';
            uniqueCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                historyCategoryFilter.appendChild(option);
            });
        }
        function displayPaymentHistory() {
            const startDate = historyStartDate.value;
            const endDate = historyEndDate.value;
            const category = historyCategoryFilter.value;
            let filteredTransactions = allTransactions.filter(tx => tx.isPaid || tx.type === 'income');
            if (startDate) { const start = new Date(startDate); start.setHours(0,0,0,0); filteredTransactions = filteredTransactions.filter(tx => tx.createdAt?.toDate() >= start); }
            if (endDate) { const end = new Date(endDate); end.setHours(23,59,59,999); filteredTransactions = filteredTransactions.filter(tx => tx.createdAt?.toDate() <= end); }
            if (category) { filteredTransactions = filteredTransactions.filter(tx => tx.category === category); }
            filteredTransactions.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
            if (filteredTransactions.length === 0) {
                paymentHistoryList.innerHTML = '<p class="text-slate-500">Filtreyle eşleşen bir işlem bulunmuyor.</p>';
            } else {
                 paymentHistoryList.innerHTML = filteredTransactions.map(tx => { 
                    const isIncome = tx.type === 'income'; 
                    const transactionDate = tx.createdAt ? tx.createdAt.toDate().toLocaleDateString('tr-TR') : 'Tarih yok';
                    return `<div class="flex justify-between items-center p-3 rounded-lg bg-slate-50 dark:bg-slate-700/50"><div><p class="font-semibold">${tx.description} <span class="text-sm font-normal text-slate-500">(${tx.category})</span></p><p class="text-sm text-slate-500">İşlem Tarihi: ${transactionDate}</p></div><p class="font-bold ${isIncome ? 'text-green-500' : 'text-red-500'}">${isIncome ? '+' : '-'} ${tx.amount.toFixed(2)} ₺</p></div>` 
                }).join('');
            }
            renderHistoryChart(filteredTransactions);
        }
        [historyStartDate, historyEndDate, historyCategoryFilter].forEach(el => { el.addEventListener('change', displayPaymentHistory); });
        clearHistoryFilterBtn.addEventListener('click', () => {
            historyStartDate.value = '';
            historyEndDate.value = '';
            historyCategoryFilter.value = '';
            document.querySelectorAll('.date-filter-btn').forEach(btn => btn.classList.remove('active'));
            displayPaymentHistory();
        });
        document.querySelectorAll('.date-filter-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                document.querySelectorAll('.date-filter-btn').forEach(btn => btn.classList.remove('active'));
                e.currentTarget.classList.add('active');
                const period = parseInt(e.currentTarget.dataset.period);
                const endDate = new Date();
                const startDate = new Date();
                startDate.setMonth(startDate.getMonth() - period);
                historyStartDate.value = startDate.toISOString().split('T')[0];
                historyEndDate.value = endDate.toISOString().split('T')[0];
                displayPaymentHistory();
            });
        });
        function renderHistoryChart(transactions) {
            if (historyChart) {
                historyChart.destroy();
            }

            const monthlyData = transactions.reduce((acc, tx) => {
                if (!tx.createdAt) { return acc; }
                const monthKey = tx.createdAt.toDate().toISOString().slice(0, 7);
                if (!acc[monthKey]) { acc[monthKey] = { income: 0, expense: 0 }; }
                if (tx.type === 'income') { acc[monthKey].income += tx.amount; } 
                else if (tx.isPaid) { acc[monthKey].expense += tx.amount; }
                return acc;
            }, {});

            const sortedMonthKeys = Object.keys(monthlyData).sort();

            if (sortedMonthKeys.length === 0) {
                historyChartContainer.innerHTML = '<p class="text-center text-slate-500 py-10">Grafik için veri bulunmuyor.</p>';
                return;
            } else {
                historyChartContainer.innerHTML = '';
            }

            const incomeData = sortedMonthKeys.map(key => monthlyData[key].income);
            const expenseData = sortedMonthKeys.map(key => monthlyData[key].expense);
            const categories = sortedMonthKeys.map(key => new Date(key + '-02').toLocaleString('tr-TR', { month: 'long', year: 'numeric' }));

            const options = {
                series: [{
                    name: 'Gelir',
                    data: incomeData
                }, {
                    name: 'Gider',
                    data: expenseData
                }],
                chart: {
                    type: 'bar',
                    height: 350,
                    toolbar: { show: true, tools: { download: '<i class="fa-solid fa-download text-slate-500"></i>' } }
                },
                plotOptions: { bar: { horizontal: false, columnWidth: '60%', endingShape: 'rounded' }, },
                dataLabels: { enabled: false },
                stroke: { show: true, width: 2, colors: ['transparent'] },
                xaxis: {
                    categories: categories,
                    labels: { style: { colors: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#4b5563' } }
                },
                yaxis: {
                    title: { text: 'Tutar (₺)', style: { color: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#4b5563' } },
                    labels: { style: { colors: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#4b5563' }, formatter: (val) => { return val.toFixed(0) + " ₺" } }
                },
                fill: { opacity: 1 },
                tooltip: {
                    theme: document.documentElement.classList.contains('dark') ? 'dark' : 'light',
                    y: { formatter: function (val) { return val.toFixed(2) + " ₺" } }
                },
                colors: ['#22c55e', '#ef4444'],
                legend: {
                    position: 'top',
                    horizontalAlign: 'right',
                    labels: { colors: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#4b5563' }
                },
                grid: { borderColor: document.documentElement.classList.contains('dark') ? '#334155' : '#e2e8f0' }
            };

            historyChart = new ApexCharts(historyChartContainer, options);
            historyChart.render();
        }
        function openDeleteModal(id, type, subId = null) {
            itemToDelete = { id, type, subId };
            const title = document.getElementById('delete-modal-title');
            const text = document.getElementById('delete-modal-text');
            if (type === 'note') { title.textContent = 'Notu Sil'; text.textContent = 'Bu notu silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.'; } 
            else if (type === 'budget') { title.textContent = 'Bütçeyi Kaldır'; text.textContent = `Bu kategori için belirlenen bütçeyi kaldırmak istediğinizden emin misiniz? (İşlemleriniz silinmeyecektir.)`; } 
            else if (type === 'creditCard') { title.textContent = 'Kredi Kartını Sil'; text.textContent = 'Bu kartı ve ilişkili tüm harcamaları silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.'; }
            else if (type === 'cardDebt') { title.textContent = 'Kart Harcamasını Sil'; text.textContent = 'Bu harcamayı silmek istediğinizden emin misiniz?'; }
            else if (type === 'manualDebt') { title.textContent = 'Borcu Sil'; text.textContent = 'Bu borcu silmek istediğinizden emin misiniz?'; }
            else { title.textContent = 'İşlemi Sil'; text.textContent = 'Bu işlemi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.'; }
            deleteModal.classList.remove('hidden');
        }
        function closeDeleteModal() {
            deleteModal.classList.add('hidden');
            itemToDelete = { id: null, type: null, subId: null };
        }
        cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        
        confirmDeleteBtn.addEventListener('click', async () => {
            if (!currentUserId || !itemToDelete.id) return;
            
            let collectionName;
            let docId = itemToDelete.id;
            let docPath;

            switch(itemToDelete.type) {
                case 'note': collectionName = 'notes'; break;
                case 'transaction': collectionName = 'transactions'; break;
                case 'budget': collectionName = 'budgets'; break;
                case 'creditCard': collectionName = 'creditCards'; break;
                case 'manualDebt': collectionName = 'manualDebts'; break;
                case 'cardDebt': 
                    docPath = `artifacts/${appId}/users/${currentUserId}/creditCards/${itemToDelete.id}/debts/${itemToDelete.subId}`;
                    break;
                default: return;
            }
            
            if (!docPath) {
                docPath = `artifacts/${appId}/users/${currentUserId}/${collectionName}/${docId}`;
            }

            try {
                if (itemToDelete.type === 'transaction') {
                    const transactionToDelete = allTransactions.find(tx => tx.id === itemToDelete.id);
                    if (transactionToDelete && transactionToDelete.type === 'expense' && transactionToDelete.isPaid) {
                        const newBalance = userSettings.accountBalance + transactionToDelete.amount;
                        await updateBalanceInFirestore(newBalance);
                        updateBalanceDisplay();
                    }
                }

                if (itemToDelete.type === 'creditCard') {
                    const debtsQuery = query(collection(db, `artifacts/${appId}/users/${currentUserId}/creditCards/${itemToDelete.id}/debts`));
                    const debtSnapshot = await getDocs(debtsQuery);
                    const batch = writeBatch(db);
                    debtSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                }

                await deleteDoc(doc(db, docPath));

                if (itemToDelete.type === 'note' && activeNoteIdInput.value === itemToDelete.id) {
                     activeNoteIdInput.value = '';
                     noteTitleInput.value = '';
                     if (quill) quill.setText('');
                }
                
                if (itemToDelete.type === 'cardDebt' || itemToDelete.type === 'creditCard') {
                    displayCreditCards();
                }

                closeDeleteModal();
            } catch (error) {
                console.error("Silme hatası: ", error);
                showNotification('Öğe silinirken bir hata oluştu.');
                closeDeleteModal();
            }
        });

        function openEditModal(tx) {
            editForm.reset();
            editForm.id.value = tx.id;
            editForm.type.value = tx.type;
            editForm.description.value = tx.description;
            editForm.amount.value = tx.amount;
            
            const dueDateContainer = document.getElementById('edit-dueDate-container');
            const recurringContainer = document.getElementById('edit-recurring-container');
            const categorySelect = editForm.querySelector('select[name="category"]');

            dueDateContainer.classList.add('hidden');
            recurringContainer.classList.add('hidden');

            const isFixedExpense = defaultFixedExpenseCategories.includes(tx.category);

            if (tx.type === 'income') {
                populateSelect(categorySelect, defaultIncomeCategories);
                dueDateContainer.classList.remove('hidden');
                recurringContainer.classList.remove('hidden');
            } else if (isFixedExpense) {
                populateSelect(categorySelect, defaultFixedExpenseCategories);
                dueDateContainer.classList.remove('hidden');
                recurringContainer.classList.remove('hidden');
            } else { // Irregular expense
                const allIrregular = [...defaultIrregularExpenseCategories, ...customCategories.map(c => c.name)];
                populateSelect(categorySelect, allIrregular);
                dueDateContainer.classList.remove('hidden');
            }
            
            editForm.dueDate.value = tx.dueDate || '';
            editForm.isRecurring.checked = tx.isRecurring || false;
            categorySelect.value = tx.category;
            editModal.classList.remove('hidden');
        }
        function closeEditModal() { editModal.classList.add('hidden'); }
        cancelEditBtn.addEventListener('click', closeEditModal);
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            const id = editForm.id.value;
            const category = editForm.category.value;
            const isFixedExpense = defaultFixedExpenseCategories.includes(category);
            
            const updatedData = {
                description: editForm.description.value,
                amount: parseFloat(editForm.amount.value),
                category: category,
                type: defaultIncomeCategories.includes(category) ? 'income' : 'expense',
            };

            if (updatedData.type === 'income' || isFixedExpense) {
                updatedData.dueDate = editForm.dueDate.value;
                updatedData.isRecurring = editForm.isRecurring.checked;
            } else {
                updatedData.dueDate = editForm.dueDate.value;
                updatedData.isRecurring = false;
            }

            try {
                const docPath = `artifacts/${appId}/users/${currentUserId}/transactions/${id}`;
                await updateDoc(doc(db, docPath), updatedData);
                closeEditModal();
            } catch (error) {
                console.error("İşlem güncellenirken hata oluştu:", error);
            } finally {
                submitButton.disabled = false;
            }
        });
        searchInput.addEventListener('input', displayTransactions);
        exportCsvBtn.addEventListener('click', () => {
            const headers = ["Tarih", "Açıklama", "Kategori", "Tip", "Tutar", "Son Odeme", "Ödendi"];
            const rows = allTransactions.map(tx => [ tx.createdAt ? tx.createdAt.toDate().toLocaleDateString('tr-TR') : 'N/A', `"${tx.description.replace(/"/g, '""')}"`, tx.category, tx.type === 'income' ? 'Gelir' : 'Gider', tx.amount, tx.dueDate || '', tx.isPaid ? 'Evet' : 'Hayır' ]);
            let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "finans_raporu.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        importCsvBtn.addEventListener('click', () => csvFileInput.click());
        csvFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { processCSV(e.target.result); };
            reader.readAsText(file);
            csvFileInput.value = '';
        });
        function autoCategorize(description) {
            const desc = description.toLowerCase();
            if (desc.includes('market') || desc.includes('migros') || desc.includes('carrefour') || desc.includes('a101') || desc.includes('bim')) return 'Market';
            if (desc.includes('fatura') || desc.includes('vodafone') || desc.includes('turkcell') || desc.includes('telekom') || desc.includes('elektrik') || desc.includes('enerjisa')) return 'Fatura';
            if (desc.includes('kira')) return 'Kira';
            if (desc.includes('netflix') || desc.includes('spotify') || desc.includes('youtube')) return 'Abonelik';
            if (desc.includes('ulaşım') || desc.includes('akbil') || desc.includes('otobüs')) return 'Ulaşım';
            return 'Diğer Gider';
        }
        function processCSV(csvText) {
            const lines = csvText.split(/\r\n|\n/).slice(1);
            const allExpenseCategories = [...defaultFixedExpenseCategories, ...defaultIrregularExpenseCategories, ...customCategories.map(c => c.name)];
            parsedCsvData = [];
            lines.forEach(line => {
                const values = line.split(',');
                if (values.length < 3) return;
                const date = values[0];
                const description = values[1].replace(/"/g, '');
                const amount = parseFloat(values[2].replace(',', '.'));
                if (description && !isNaN(amount) && amount < 0) {
                    parsedCsvData.push({ date, description, amount: Math.abs(amount), category: autoCategorize(description) });
                }
            });
            renderImportPreview(parsedCsvData, allExpenseCategories);
            importModal.classList.remove('hidden');
        }
        function renderImportPreview(data, categories) {
            importPreviewList.innerHTML = '';
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = "text-sm";
                const categoryOptions = categories.map(c => `<option value="${c}" ${c === item.category ? 'selected' : ''}>${c}</option>`).join('');
                row.innerHTML = `<td class="px-4 py-2">${item.date}</td><td class="px-4 py-2">${item.description}</td><td class="px-4 py-2">${item.amount.toFixed(2)} ₺</td><td class="px-4 py-2"><select data-index="${index}" class="import-category-select block w-full px-2 py-1 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-sm">${categoryOptions}</select></td>`;
                importPreviewList.appendChild(row);
            });
        }
        cancelImportBtn.addEventListener('click', () => importModal.classList.add('hidden'));
        confirmImportBtn.addEventListener('click', async () => {
            const batch = writeBatch(db);
            const collectionPath = `artifacts/${appId}/users/${currentUserId}/transactions`;
            document.querySelectorAll('.import-category-select').forEach(select => {
                const index = select.dataset.index;
                parsedCsvData[index].category = select.value;
            });
            parsedCsvData.forEach(item => {
                const docRef = doc(collection(db, collectionPath));
                const data = { description: item.description, amount: item.amount, category: item.category, type: 'expense', createdAt: serverTimestamp() };
                batch.set(docRef, data);
            });
            try {
                await batch.commit();
                importModal.classList.add('hidden');
            } catch (error) {
                console.error("Toplu işlem hatası:", error);
            }
        });
        function loadBudgets() {
            if (!currentUserId) return;
            if (budgetsUnsubscribe) budgetsUnsubscribe();
            const q = query(collection(db, `artifacts/${appId}/users/${currentUserId}/budgets`));
            return new Promise((resolve) => {
                budgetsUnsubscribe = onSnapshot(q, (snapshot) => {
                    allBudgets = {};
                    snapshot.forEach(doc => { allBudgets[doc.id] = doc.data(); });
                    displayBudgets();
                    resolve();
                }, error => {
                    console.error("Bütçeler yüklenemedi:", error);
                    resolve();
                });
            });
        }
        function displayBudgets() {
            const budgetedCategories = Object.keys(allBudgets).sort();
            const { startDate, endDate } = getCurrentFinancialCycle(userSettings.paymentDay);
            const cycleTransactions = allTransactions.filter(tx => { const txDate = tx.createdAt?.toDate(); return txDate && txDate >= startDate && txDate <= endDate; });
            budgetList.innerHTML = '';
            if (budgetedCategories.length === 0) {
                budgetList.innerHTML = `<p class="text-slate-500 text-sm text-center p-4">Takip edilecek bütçe eklenmedi. Başlamak için '+ Ekle' butonunu kullanın.</p>`;
                return;
            }
            budgetedCategories.forEach(category => {
                const budgetAmount = allBudgets[category]?.amount || 0;
                const spentAmount = cycleTransactions.filter(tx => tx.type === 'expense' && tx.category === category).reduce((sum, tx) => sum + tx.amount, 0);
                let progressBarHTML;
                if (budgetAmount > 0) {
                    const percentage = (spentAmount / budgetAmount) * 100;
                    let progressBarColor = 'bg-green-500';
                    if (percentage > 90) progressBarColor = 'bg-red-500';
                    else if (percentage > 70) progressBarColor = 'bg-yellow-500';
                    progressBarHTML = `<div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5"><div class="${progressBarColor} h-2.5 rounded-full" style="width: ${Math.min(percentage, 100)}%"></div></div>`;
                } else {
                    progressBarHTML = `<div class="w-full bg-slate-100 dark:bg-slate-800 rounded-full h-2.5 border border-dashed border-slate-300 dark:border-slate-600"></div>`;
                }
                const item = document.createElement('div');
                item.innerHTML = `<div class="flex justify-between items-center mb-1 text-sm"><span class="font-semibold">${category}</span><div class="flex items-center"><span class="text-slate-500 dark:text-slate-400">${spentAmount.toFixed(2)}₺ / ${budgetAmount > 0 ? budgetAmount.toFixed(2) + '₺' : 'Bütçe Yok'}</span><button data-category="${category}" class="edit-budget-btn ml-2 text-slate-400 hover:text-indigo-500"><i class="fa-solid fa-pencil"></i></button><button data-category="${category}" class="delete-budget-btn ml-2 text-slate-400 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></div></div>${progressBarHTML}`;
                budgetList.appendChild(item);
            });
            budgetList.querySelectorAll('.edit-budget-btn').forEach(button => {
                button.addEventListener('click', (e) => openBudgetModal(e.currentTarget.dataset.category, 'edit'));
            });
            budgetList.querySelectorAll('.delete-budget-btn').forEach(button => {
                button.addEventListener('click', (e) => openDeleteModal(e.currentTarget.dataset.category, 'budget'));
            });
        }
        function openBudgetModal(category, mode = 'edit') {
            const title = document.getElementById('budget-modal-title');
            const selectContainer = document.getElementById('budget-category-select-container');
            const labelContainer = document.getElementById('budget-category-label-container');
            const categorySelect = document.getElementById('budget-category-select');
            const hiddenCategoryInput = budgetForm.querySelector('input[name="category"]');
            if (mode === 'add') {
                title.textContent = 'Yeni Bütçe Ekle';
                selectContainer.classList.remove('hidden');
                labelContainer.classList.add('hidden');
                const allExpenseCategories = [...defaultFixedExpenseCategories, ...defaultIrregularExpenseCategories, ...customCategories.map(c => c.name)];
                const unbudgetedCategories = allExpenseCategories.filter(c => !allBudgets[c]);
                populateSelect(categorySelect, unbudgetedCategories);
                budgetForm.amount.value = '';
                hiddenCategoryInput.value = categorySelect.value;
                categorySelect.onchange = () => { hiddenCategoryInput.value = categorySelect.value; };
            } else {
                title.textContent = 'Bütçeyi Düzenle';
                selectContainer.classList.add('hidden');
                labelContainer.classList.remove('hidden');
                hiddenCategoryInput.value = category;
                document.getElementById('budget-category-label').textContent = `${category} için Bütçe`;
                budgetForm.amount.value = allBudgets[category]?.amount || '';
            }
            budgetModal.classList.remove('hidden');
        }
        addBudgetBtn.addEventListener('click', () => openBudgetModal(null, 'add'));
        cancelBudgetBtn.addEventListener('click', () => budgetModal.classList.add('hidden'));
        budgetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const category = budgetForm.querySelector('input[name="category"]').value;
            const amount = parseFloat(budgetForm.amount.value);
            if (!category || isNaN(amount) || amount < 0) {
                showNotification("Lütfen geçerli bir kategori ve tutar girin.");
                return;
            }
            const docPath = `artifacts/${appId}/users/${currentUserId}/budgets/${category}`;
            try {
                await setDoc(doc(db, docPath), { amount });
                budgetModal.classList.add('hidden');
            } catch (error) {
                console.error("Bütçe kaydedilemedi:", error);
                showNotification('Bütçe kaydedilemedi.');
            }
        });
        function initializeBudgetToggle() {
            const icon = toggleBudgetListBtn.querySelector('i');
            let isHidden = localStorage.getItem('isBudgetHidden') === 'true';
            const setState = (hidden) => {
                isHidden = hidden;
                budgetList.classList.toggle('hidden', isHidden);
                icon.classList.toggle('fa-chevron-up', !isHidden);
                icon.classList.toggle('fa-chevron-down', isHidden);
                localStorage.setItem('isBudgetHidden', isHidden);
            };
            toggleBudgetListBtn.addEventListener('click', () => { setState(!isHidden); });
            setState(isHidden);
        }
        function initializeQuillEditor() {
            if (quill) return;
            const toolbarOptions = [ [{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['clean'] ];
            quill = new Quill('#note-editor', { modules: { toolbar: toolbarOptions }, theme: 'snow', placeholder: 'Notlarınızı buraya yazın...' });
            quill.on('text-change', (delta, oldDelta, source) => { if (source === 'user') { saveActiveNote(); } });
        }
        notepadBtn.addEventListener('click', () => notepadModal.classList.remove('hidden'));
        closeNotepadBtn.addEventListener('click', () => notepadModal.classList.add('hidden'));
        function loadNotes() {
            if (!currentUserId) return;
            if (notesUnsubscribe) notesUnsubscribe();
            const q = query(collection(db, `artifacts/${appId}/users/${currentUserId}/notes`), orderBy("updatedAt", "desc"));
            return new Promise((resolve) => {
                notesUnsubscribe = onSnapshot(q, (snapshot) => {
                    allNotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    displayNotesList();
                    const currentActiveId = activeNoteIdInput.value;
                    const activeNoteExists = allNotes.some(note => note.id === currentActiveId);
                    if (!activeNoteExists && allNotes.length > 0) {
                        selectNote(allNotes[0].id);
                    } else if (allNotes.length === 0) {
                        activeNoteIdInput.value = '';
                        noteTitleInput.value = '';
                        if(quill) quill.setContents([]);
                    }
                    resolve();
                }, (error) => {
                    console.error("Notlar yüklenemedi:", error);
                    resolve();
                });
            });
        }
        function getTextFromDelta(deltaString) {
            if (!deltaString) return 'İçerik yok';
            try {
                const delta = JSON.parse(deltaString);
                const text = delta.ops.map(op => op.insert).join('').trim();
                if (!text) return 'İçerik yok';
                return text.substring(0, 30) + (text.length > 30 ? '...' : '');
            } catch (e) {
                return deltaString.substring(0, 30) + (deltaString.length > 30 ? '...' : '');
            }
        }
        function displayNotesList() {
            notesList.innerHTML = '';
            if (allNotes.length === 0) {
                notesList.innerHTML = '<p class="text-center text-sm text-slate-500 p-4">Henüz not oluşturulmadı.</p>';
                return;
            }
            allNotes.forEach(note => {
                const item = document.createElement('div');
                item.className = `note-list-item p-3 rounded-md cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 flex justify-between items-start`;
                item.dataset.id = note.id;
                const isActive = note.id === activeNoteIdInput.value;
                if (isActive) item.classList.add('active');
                item.innerHTML = `<div class="truncate flex-grow"><p class="font-semibold truncate">${note.title || 'Başlıksız Not'}</p><p class="text-xs text-slate-500 dark:text-slate-400 truncate">${getTextFromDelta(note.content)}</p></div><button data-id="${note.id}" class="delete-note-btn text-slate-400 hover:text-red-500 text-xs flex-shrink-0 ml-2 p-1"><i class="fa-solid fa-trash-can"></i></button>`;
                notesList.appendChild(item);
            });
            notesList.querySelectorAll('.note-list-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-note-btn')) return;
                    selectNote(item.dataset.id);
                });
            });
            notesList.querySelectorAll('.delete-note-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openDeleteModal(e.currentTarget.dataset.id, 'note');
                });
            });
        }
        function selectNote(noteId) {
            if (!quill) return;
            const note = allNotes.find(n => n.id === noteId);
            if (!note) return;
            activeNoteIdInput.value = note.id;
            noteTitleInput.value = note.title || '';
            try {
                const delta = JSON.parse(note.content);
                quill.setContents(delta);
            } catch(e) {
                quill.setText(note.content || '');
            }
            document.querySelectorAll('.note-list-item').forEach(item => {
                item.classList.toggle('active', item.dataset.id === noteId);
            });
        }
        newNoteBtn.addEventListener('click', async () => {
            if (!currentUserId) return;
            try {
                const newNoteRef = await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/notes`), {
                    title: 'Yeni Not',
                    content: JSON.stringify({ ops: [] }),
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
                selectNote(newNoteRef.id);
            } catch (error) {
                console.error("Yeni not oluşturulamadı:", error);
            }
        });
        const saveActiveNote = () => {
            clearTimeout(noteSaveTimeout);
            notepadStatus.textContent = 'Değişiklikler algılandı...';
            noteSaveTimeout = setTimeout(async () => {
                const noteId = activeNoteIdInput.value;
                if (!noteId || !currentUserId || !quill) return;
                notepadStatus.textContent = 'Kaydediliyor...';
                const data = {
                    title: noteTitleInput.value,
                    content: JSON.stringify(quill.getContents()),
                    updatedAt: serverTimestamp()
                };
                try {
                    const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/notes/${noteId}`);
                    await updateDoc(docRef, data);
                    notepadStatus.textContent = 'Kaydedildi.';
                } catch (error) {
                    notepadStatus.textContent = 'Kaydedilemedi.';
                    console.error("Not kaydedilemedi:", error);
                }
            }, 1500);
        };
        noteTitleInput.addEventListener('keyup', saveActiveNote);
        function getFriendlyAuthError(c) { 
            switch(c){
                case 'auth/invalid-email': return 'Geçersiz e-posta adresi.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential': return 'E-posta veya şifre hatalı.';
                case 'auth/email-already-in-use': return 'Bu e-posta adresi zaten kullanılıyor.';
                case 'auth/weak-password': return 'Şifre en az 6 karakter olmalıdır.';
                default: return 'Bilinmeyen bir hata oluştu. Lütfen tekrar deneyin.';
            }
        }
        loginTabButton.addEventListener('click', () => {
            loginForm.classList.remove('hidden'); registerForm.classList.add('hidden');
            loginTabButton.classList.add('text-indigo-600', 'dark:text-indigo-400', 'border-indigo-600', 'dark:border-indigo-400'); loginTabButton.classList.remove('text-slate-500');
            registerTabButton.classList.add('text-slate-500'); registerTabButton.classList.remove('text-indigo-600', 'dark:text-indigo-400', 'border-indigo-600', 'dark:border-indigo-400');
        });
        registerTabButton.addEventListener('click', () => {
            registerForm.classList.remove('hidden'); loginForm.classList.add('hidden');
            registerTabButton.classList.add('text-indigo-600', 'dark:text-indigo-400', 'border-indigo-600', 'dark:border-indigo-400'); registerTabButton.classList.remove('text-slate-500');
            loginTabButton.classList.add('text-slate-500'); loginTabButton.classList.remove('text-indigo-600', 'dark:text-indigo-400', 'border-indigo-600', 'dark:border-indigo-400');
        });
        const handleAuthSubmit = async (e, authFunction) => {
            e.preventDefault();
            const form = e.target;
            const button = form.querySelector('button[type="submit"]');
            const email = form.querySelector('input[type="email"]').value;
            const password = form.querySelector('input[type="password"]').value;
            button.disabled = true;
            authError.textContent = '';
            try {
                await authFunction(auth, email, password);
                form.reset();
            } catch (error) {
                authError.textContent = getFriendlyAuthError(error.code);
            } finally {
                button.disabled = false;
            }
        };
        registerForm.addEventListener('submit', (e) => handleAuthSubmit(e, createUserWithEmailAndPassword));
        loginForm.addEventListener('submit', (e) => handleAuthSubmit(e, signInWithEmailAndPassword));
        logoutButton.addEventListener('click', () => signOut(auth));

        // --- GEMINI DESTEKLİ ÖZELLİKLER ---
        aiCategorizeBtn.addEventListener('click', async () => {
            if (parsedCsvData.length === 0) {
                showNotification('Önce bir CSV dosyası seçin.');
                return;
            }

            toggleLoading(true);
            const allExpenseCategories = [...defaultFixedExpenseCategories, ...defaultIrregularExpenseCategories, ...customCategories.map(c => c.name)];
            const categoryListString = allExpenseCategories.join(', ');

            const promises = parsedCsvData.map(async (item, index) => {
                const prompt = `Bir harcama açıklaması için şu kategorilerden en uygun olanı seç: ${categoryListString}. Sadece tek bir kategori adı döndür. Açıklama: "${item.description}"`;
                const suggestedCategory = await callGemini(prompt);
                
                if (suggestedCategory && allExpenseCategories.includes(suggestedCategory.trim())) {
                    const selectElement = document.querySelector(`.import-category-select[data-index="${index}"]`);
                    if (selectElement) {
                        selectElement.value = suggestedCategory.trim();
                    }
                }
            });

            await Promise.all(promises);
            toggleLoading(false);
            showNotification('Kategorizasyon tamamlandı.', 'success');
        });

        aiBudgetSuggestionBtn.addEventListener('click', async () => {
            toggleLoading(true);
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

            const recentExpenses = allTransactions.filter(tx => 
                tx.type === 'expense' && 
                tx.createdAt && 
                tx.createdAt.toDate() > threeMonthsAgo
            );

            if (recentExpenses.length < 10) {
                toggleLoading(false);
                showNotification('Yeterli harcama verisi bulunamadı. Öneri için en az 10 harcama gereklidir.');
                return;
            }

            const spendingSummary = recentExpenses.reduce((acc, tx) => {
                acc[tx.category] = (acc[tx.category] || 0) + tx.amount;
                return acc;
            }, {});

            const summaryText = Object.entries(spendingSummary)
                .map(([category, total]) => `${category}: Aylık ortalama ${(total / 3).toFixed(2)} ₺`)
                .join('\n');

            const prompt = `Sen bir kişisel finans danışmanısın. Bir kullanıcının son 3 aylık harcama verilerinin özeti aşağıdadır:\n\n${summaryText}\n\nBu bilgilere dayanarak, her kategori için mantıklı ve ulaşılabilir aylık bütçe hedefleri öner. Önerilerini madde madde ve kısa, teşvik edici açıklamalarla sun. Cevabını HTML formatında, her madde için bir <p> etiketi kullanarak oluştur.`;

            const suggestion = await callGemini(prompt);
            toggleLoading(false);

            if (suggestion) {
                aiBudgetSuggestionContent.innerHTML = suggestion;
                aiBudgetSuggestionModal.classList.remove('hidden');
            } else {
                showNotification('Bütçe önerileri alınamadı. Lütfen tekrar deneyin.');
            }
        });

        closeAiBudgetSuggestionBtn.addEventListener('click', () => {
            aiBudgetSuggestionModal.classList.add('hidden');
        });

        // --- ÖDEMELER SAYFASI FONKSİYONLARI ---
        function loadCreditCards() {
            if (!currentUserId) return;
            if (creditCardsUnsubscribe) creditCardsUnsubscribe();
            const q = query(collection(db, `artifacts/${appId}/users/${currentUserId}/creditCards`), orderBy("cardName"));
            return new Promise((resolve) => {
                creditCardsUnsubscribe = onSnapshot(q, async (snapshot) => {
                    allCreditCards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    await displayCreditCards();
                    checkReminders();
                    resolve();
                }, error => {
                    console.error("Kredi kartları yüklenemedi:", error);
                    resolve();
                });
            });
        }

        async function displayCreditCards() {
            creditCardList.innerHTML = '';
            if (allCreditCards.length === 0) {
                creditCardList.innerHTML = '<p class="text-slate-500 text-sm text-center p-4">Henüz kredi kartı eklenmedi.</p>';
                totalCardDebtEl.textContent = `0.00 ₺`;
                return;
            }

            let totalDebt = 0;

            for (const card of allCreditCards) {
                const debtsQuery = query(collection(db, `artifacts/${appId}/users/${currentUserId}/creditCards/${card.id}/debts`));
                const debtSnapshot = await getDocs(debtsQuery);
                const currentDebt = debtSnapshot.docs.reduce((sum, doc) => sum + doc.data().amount, 0);
                totalDebt += currentDebt;
                
                const availableLimit = card.limit - currentDebt;
                const cardThemeClasses = getCardThemeClasses(card.cardTheme);

                const cardEl = document.createElement('div');
                cardEl.className = `p-5 rounded-xl shadow-lg text-white font-mono flex flex-col justify-between h-52 relative overflow-hidden transition-transform transform hover:scale-105 cursor-pointer ${cardThemeClasses}`;
                cardEl.dataset.id = card.id;
                
                cardEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <span class="font-bold text-xl">${card.cardName}</span>
                        <div class="h-8 flex items-center">${getBankLogo(card.bankName)}</div>
                    </div>
                    <div>
                        <div class="mb-2">
                            <p class="text-sm text-slate-300">Güncel Borç</p>
                            <p class="text-2xl font-bold tracking-wider">${currentDebt.toFixed(2)} ₺</p>
                        </div>
                        <div class="flex justify-between items-end text-sm">
                            <div>
                                <p class="text-slate-400">Kullanılabilir Limit</p>
                                <p class="font-semibold">${availableLimit.toFixed(2)} ₺</p>
                            </div>
                            <div class="text-right">
                                <p class="text-slate-400">Son Ödeme</p>
                                <p class="font-semibold">Her Ayın ${card.paymentDueDay}'i</p>
                            </div>
                        </div>
                    </div>
                `;
                cardEl.addEventListener('click', () => openCardDetailsModal(card.id));
                creditCardList.appendChild(cardEl);
            }
            totalCardDebtEl.textContent = `${totalDebt.toFixed(2)} ₺`;
        }

        addCreditCardBtn.addEventListener('click', () => {
            creditCardForm.reset();
            creditCardForm.cardId.value = '';
            document.getElementById('credit-card-modal-title').textContent = 'Yeni Kredi Kartı Ekle';
            creditCardModal.classList.remove('hidden');
        });

        cancelCreditCardBtn.addEventListener('click', () => {
            creditCardModal.classList.add('hidden');
        });

        creditCardForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const cardId = e.target.cardId.value;
            const cardData = {
                cardName: e.target.cardName.value,
                bankName: e.target.bankName.value,
                cardTheme: e.target.cardTheme.value,
                limit: parseFloat(e.target.limit.value),
                statementDay: parseInt(e.target.statementDay.value),
                paymentDueDay: parseInt(e.target.paymentDueDay.value),
            };

            if (!cardData.cardName || isNaN(cardData.limit) || isNaN(cardData.statementDay) || isNaN(cardData.paymentDueDay)) {
                showNotification('Lütfen tüm alanları doğru doldurun.');
                return;
            }

            try {
                if (cardId) {
                    const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/creditCards`, cardId);
                    await updateDoc(docRef, cardData);
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/creditCards`), cardData);
                }
                creditCardModal.classList.add('hidden');
            } catch (error) {
                console.error("Kredi kartı kaydedilemedi:", error);
                showNotification('Kredi kartı kaydedilemedi.');
            }
        });

        async function openCardDetailsModal(cardId) {
            const card = allCreditCards.find(c => c.id === cardId);
            if (!card) return;

            document.getElementById('card-details-title').textContent = `${card.cardName} Detayları`;
            cardDebtForm.cardId.value = cardId;

            const allExpenseCategories = [...defaultIrregularExpenseCategories, ...customCategories.map(c => c.name)];
            populateSelect(cardDebtForm.debtCategory, allExpenseCategories);

            if (cardDebtsUnsubscribe) cardDebtsUnsubscribe();
            
            const q = query(collection(db, `artifacts/${appId}/users/${currentUserId}/creditCards/${cardId}/debts`), orderBy("createdAt", "desc"));
            cardDebtsUnsubscribe = onSnapshot(q, (snapshot) => {
                currentCardDebts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayCardDebts(card);
            });

            displayCardPaymentHistory(cardId);
            cardDetailsModal.classList.remove('hidden');
        }
        
        function displayCardDebts(card) {
            cardDebtList.innerHTML = '';
            let statementDebt = 0;
            
            if (currentCardDebts.length > 0) {
                currentCardDebts.forEach(debt => {
                    statementDebt += debt.amount;
                    const debtEl = document.createElement('div');
                    debtEl.className = 'flex justify-between items-center text-sm p-2 rounded-md bg-slate-100 dark:bg-slate-700/50';
                    const debtDate = debt.createdAt ? debt.createdAt.toDate().toLocaleDateString('tr-TR') : 'Tarih bekleniyor...';
                    debtEl.innerHTML = `
                        <div>
                            <p>${debt.description} <span class="text-xs text-slate-500">(${debt.category})</span></p>
                            <p class="text-xs text-slate-500">${debtDate}</p>
                        </div>
                        <div class="flex items-center">
                            <p class="font-semibold mr-4">${debt.amount.toFixed(2)} ₺</p>
                            <button data-card-id="${card.id}" data-debt-id="${debt.id}" class="delete-card-debt-btn text-slate-400 hover:text-red-500 text-xs"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    `;
                    cardDebtList.appendChild(debtEl);
                });
            } else {
                 cardDebtList.innerHTML = '<p class="text-slate-500 text-sm text-center p-2">Bu dönem için harcama yok.</p>';
            }

            renderCardDebtChart(currentCardDebts);

            const minimumPayment = statementDebt * 0.20;
            document.getElementById('card-statement-debt').textContent = `${statementDebt.toFixed(2)} ₺`;
            document.getElementById('card-minimum-payment').textContent = `${minimumPayment.toFixed(2)} ₺`;
            
            payStatementDebtBtn.dataset.amount = statementDebt;
            payStatementDebtBtn.dataset.cardName = card.cardName;
            payStatementDebtBtn.disabled = statementDebt <= 0;

            payMinimumDebtBtn.dataset.amount = minimumPayment;
            payMinimumDebtBtn.dataset.cardName = card.cardName;
            payMinimumDebtBtn.disabled = minimumPayment <= 0;

            cardDebtList.querySelectorAll('.delete-card-debt-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const cardId = e.currentTarget.dataset.cardId;
                    const debtId = e.currentTarget.dataset.debtId;
                    openDeleteModal(cardId, 'cardDebt', debtId);
                });
            });
        }

        async function displayCardPaymentHistory(cardId) {
            cardPaymentHistoryList.innerHTML = '';
            const historyRef = collection(db, `artifacts/${appId}/users/${currentUserId}/creditCards/${cardId}/paymentHistory`);
            const historyQuery = query(historyRef, orderBy("paidAt", "desc"));
            const historySnapshot = await getDocs(historyQuery);

            if (historySnapshot.empty) {
                cardPaymentHistoryList.innerHTML = '<p class="text-slate-500 text-sm text-center p-2">Ödeme geçmişi bulunmuyor.</p>';
                return;
            }

            historySnapshot.forEach(doc => {
                const historyData = doc.data();
                const paidDate = historyData.paidAt ? historyData.paidAt.toDate().toLocaleDateString('tr-TR') : 'Bilinmiyor';
                const historyEl = document.createElement('div');
                historyEl.className = 'flex justify-between items-center p-2 rounded-md bg-slate-50 dark:bg-slate-700/30 opacity-70';
                historyEl.innerHTML = `
                    <div>
                        <p>${historyData.description} ${historyData.isPartial ? `<span class="text-xs text-orange-500">(Kısmi)</span>` : ''}</p>
                        <p class="text-xs text-slate-500">Ödenme Tarihi: ${paidDate}</p>
                    </div>
                    <p class="font-semibold text-green-500">+${historyData.amount.toFixed(2)} ₺</p>
                `;
                cardPaymentHistoryList.appendChild(historyEl);
            });
        }

        closeCardDetailsBtn.addEventListener('click', () => {
            cardDetailsModal.classList.add('hidden');
            if (cardDebtsUnsubscribe) cardDebtsUnsubscribe();
            currentCardDebts = [];
            if (cardDebtChart) {
                cardDebtChart.destroy();
                cardDebtChart = null;
            }
        });

        cardDebtForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const cardId = e.target.cardId.value;
            const debtData = {
                description: e.target.debtDescription.value,
                amount: parseFloat(e.target.debtAmount.value),
                category: e.target.debtCategory.value,
                createdAt: serverTimestamp()
            };

            if (!debtData.description || isNaN(debtData.amount) || debtData.amount <= 0 || !debtData.category) {
                showNotification('Lütfen tüm alanları doğru doldurun.');
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/creditCards/${cardId}/debts`), debtData);
                cardDebtForm.reset();
                cardDebtForm.cardId.value = cardId;
                displayCreditCards();
            } catch (error) {
                console.error("Kart harcaması eklenemedi:", error);
                showNotification('Harcama eklenemedi.');
            }
        });

        async function payCardDebt(cardName, paymentAmount, cardId) {
            if (isNaN(paymentAmount) || paymentAmount <= 0) return;
            toggleLoading(true);
            try {
                const newTransaction = {
                    description: `${cardName} Kredi Kartı Ödemesi`,
                    amount: paymentAmount,
                    category: 'Kredi',
                    type: 'expense',
                    isPaid: true,
                    createdAt: serverTimestamp()
                };
                await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/transactions`), newTransaction);
                const newBalance = userSettings.accountBalance - paymentAmount;
                await updateBalanceInFirestore(newBalance);
                updateBalanceDisplay();

                const debtsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/creditCards/${cardId}/debts`);
                const debtsQuery = query(debtsRef, orderBy("createdAt", "asc"));
                const debtSnapshot = await getDocs(debtsQuery);
                let remainingPayment = paymentAmount;
                const batch = writeBatch(db);
                const historyRef = collection(db, `artifacts/${appId}/users/${currentUserId}/creditCards/${cardId}/paymentHistory`);

                for (const debtDoc of debtSnapshot.docs) {
                    if (remainingPayment <= 0) break;
                    const debtData = debtDoc.data();
                    const debtAmount = debtData.amount;
                    if (remainingPayment >= debtAmount) {
                        batch.delete(debtDoc.ref);
                        const newHistoryDocRef = doc(historyRef);
                        batch.set(newHistoryDocRef, { ...debtData, paidAt: serverTimestamp() });
                        remainingPayment -= debtAmount;
                    } else {
                        const newDebtAmount = debtAmount - remainingPayment;
                        batch.update(debtDoc.ref, { amount: newDebtAmount });
                        const newHistoryDocRef = doc(historyRef);
                        batch.set(newHistoryDocRef, { ...debtData, amount: remainingPayment, paidAt: serverTimestamp(), isPartial: true });
                        remainingPayment = 0;
                    }
                }
                await batch.commit();
                showNotification(`${paymentAmount.toFixed(2)} ₺ ödeme yapıldı, borçlar güncellendi.`, 'success');
                cardDetailsModal.classList.add('hidden');
                displayCreditCards();
            } catch (error) {
                console.error("Kart ödemesi oluşturulamadı:", error);
                showNotification("Ödeme işlemi oluşturulurken bir hata oluştu.");
            } finally {
                toggleLoading(false);
            }
        }

        payStatementDebtBtn.addEventListener('click', (e) => {
            const amount = parseFloat(e.currentTarget.dataset.amount);
            const cardName = e.currentTarget.dataset.cardName;
            const cardId = cardDebtForm.cardId.value;
            payCardDebt(cardName, amount, cardId);
        });

        payMinimumDebtBtn.addEventListener('click', (e) => {
            const amount = parseFloat(e.currentTarget.dataset.amount);
            const cardName = e.currentTarget.dataset.cardName;
            const cardId = cardDebtForm.cardId.value;
            payCardDebt(cardName, amount, cardId);
        });


        // Elden Borç Yönetimi
        function loadManualDebts() {
            if (!currentUserId) return;
            if (manualDebtsUnsubscribe) manualDebtsUnsubscribe();
            const q = query(collection(db, `artifacts/${appId}/users/${currentUserId}/manualDebts`), orderBy("createdAt", "desc"));
            return new Promise((resolve) => {
                manualDebtsUnsubscribe = onSnapshot(q, (snapshot) => {
                    allManualDebts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    displayManualDebts();
                    resolve();
                }, error => {
                    console.error("Diğer borçlar yüklenemedi:", error);
                    resolve();
                });
            });
        }

        function displayManualDebts() {
            manualDebtList.innerHTML = '';
            let totalDebt = 0;
            if (allManualDebts.length === 0) {
                manualDebtList.innerHTML = '<p class="text-slate-500 text-sm text-center p-2">Takip edilen borç yok.</p>';
            } else {
                allManualDebts.forEach(debt => {
                    totalDebt += debt.amount;
                    const debtEl = document.createElement('div');
                    debtEl.className = 'flex justify-between items-center text-sm p-2 rounded-md bg-slate-100 dark:bg-slate-700/50';
                    debtEl.innerHTML = `
                        <p>${debt.description}</p>
                        <div class="flex items-center gap-4">
                            <p class="font-semibold">${debt.amount.toFixed(2)} ₺</p>
                            <button data-id="${debt.id}" class="close-manual-debt-btn text-green-500 hover:text-green-600" title="Borcu Kapat"><i class="fa-solid fa-check-circle"></i></button>
                            <button data-id="${debt.id}" class="delete-manual-debt-btn text-slate-400 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    `;
                    manualDebtList.appendChild(debtEl);
                });
            }
            totalManualDebtEl.textContent = `${totalDebt.toFixed(2)} ₺`;

            manualDebtList.querySelectorAll('.delete-manual-debt-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    openDeleteModal(e.currentTarget.dataset.id, 'manualDebt');
                });
            });
            manualDebtList.querySelectorAll('.close-manual-debt-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    payManualDebt(e.currentTarget.dataset.id);
                });
            });
        }
        
        async function payManualDebt(debtId) {
            const debt = allManualDebts.find(d => d.id === debtId);
            if (!debt) return;

            toggleLoading(true);
            try {
                const newTransaction = {
                    description: `${debt.description} borcu kapatıldı`,
                    amount: debt.amount,
                    category: 'Diğer Gider',
                    type: 'expense',
                    isPaid: true,
                    createdAt: serverTimestamp()
                };
                await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/transactions`), newTransaction);
                
                const newBalance = userSettings.accountBalance - debt.amount;
                await updateBalanceInFirestore(newBalance);
                updateBalanceDisplay();

                await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/manualDebts`, debtId));

                showNotification('Borç kapatıldı ve gider olarak eklendi.', 'success');
            } catch(error) {
                console.error("Borç kapatılamadı:", error);
                showNotification("Borç kapatılırken bir hata oluştu.");
            } finally {
                toggleLoading(false);
            }
        }

        manualDebtForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const debtData = {
                description: e.target.debtDescription.value,
                amount: parseFloat(e.target.debtAmount.value),
                createdAt: serverTimestamp()
            };
            if (!debtData.description || isNaN(debtData.amount) || debtData.amount <= 0) {
                showNotification('Lütfen geçerli bir açıklama ve tutar girin.');
                return;
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/manualDebts`), debtData);
                manualDebtForm.reset();
            } catch (error) {
                console.error("Borç eklenemedi:", error);
                showNotification('Borç eklenemedi.');
            }
        });

        // GÜNCELLENDİ: Kart Görseli Yardımcı Fonksiyonları
        function getCardThemeClasses(theme) {
            switch (theme) {
                case 'blue': return 'bg-gradient-to-br from-blue-500 to-blue-800';
                case 'green': return 'bg-gradient-to-br from-green-500 to-green-800';
                case 'purple': return 'bg-gradient-to-br from-purple-500 to-purple-800';
                default: return 'bg-gradient-to-br from-slate-700 to-slate-900';
            }
        }
        function getBankLogo(bankName) {
            const name = bankName.toLowerCase();
            const logoClass = "h-8 opacity-90";
            switch(name) {
                case 'garanti': return `<img src="/images/garanti.svg" class="${logoClass}" alt="Garanti Logo">`;
                case 'akbank': return `<img src="/image/akbank.svg" class="${logoClass}" alt="Akbank Logo">`;
                case 'iş bankası': return `<img src="/image/isbank.svg" class="${logoClass}" alt="İş Bankası Logo">`;
                case 'yapı kredi': return `<img src="/image/yapikredi.svg" class="${logoClass}" alt="Yapı Kredi Logo">`;
                case 'qnb finansbank': return `<img src="/image/qnb.svg" class="${logoClass}" alt="QNB Finansbank Logo">`;
                case 'halkbank': return `<img src="/image/halkbank.svg" class="${logoClass}" alt="Halkbank Logo">`;
                case 'vakıfbank': return `<img src="/image/vakif.svg" class="${logoClass}" alt="Vakıfbank Logo">`;
                case 'ziraat bankası': return `<img src="/image/ziraat.svg" class="${logoClass}" alt="Ziraat Bankası Logo">`;
                case 'denizbank': return `<img src="/image/denizbank.svg" class="${logoClass}" alt="Denizbank Logo">`;
                case 'ing': return `<img src="/image/ing.svg" class="${logoClass}" alt="ING Logo">`;
                default: return '<i class="fa-solid fa-credit-card text-3xl opacity-50"></i>';
            }
        }

        // YENİ: Kart Harcama Grafiği
        function renderCardDebtChart(debts) {
            if (cardDebtChart) {
                cardDebtChart.destroy();
            }

            const categoryTotals = debts.reduce((acc, debt) => {
                acc[debt.category] = (acc[debt.category] || 0) + debt.amount;
                return acc;
            }, {});

            const labels = Object.keys(categoryTotals);
            const data = Object.values(categoryTotals);

            if (labels.length === 0) {
                cardDebtChartContainer.innerHTML = '<p class="text-center text-slate-500 mt-16">Grafik için harcama verisi yok.</p>';
                return;
            } else {
                cardDebtChartContainer.innerHTML = '<canvas id="cardDebtChart"></canvas>';
            }
            
            const canvas = document.getElementById('cardDebtChart');
            if (canvas) {
                cardDebtChart = new Chart(canvas.getContext('2d'), {
                    type: 'doughnut',
                    data: { 
                        labels, 
                        datasets: [{ 
                            data, 
                            backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7'], 
                            borderColor: document.documentElement.classList.contains('dark') ? '#1e293b' : '#ffffff', 
                            borderWidth: 2 
                        }] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { 
                                display: false 
                            } 
                        } 
                    }
                });
            }
        }

    </script>
</body>
</html>
